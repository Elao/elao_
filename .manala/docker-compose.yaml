version: '3.5'

services:

  #########
  # Nginx #
  #########

  nginx:
    hostname: nginx.elao
    build:
      context: .
      target: nginx
    restart: always
    ports:
      - '8080:80'
    volumes:
      - ./nginx/app.conf:/etc/nginx/conf.d/default.conf:ro
      - ..:/srv:cached
    links:
      - app

  ###########
  # MailDev #
  ###########

  maildev:
    hostname: maildev.elao
    build:
      context: .
      target: maildev
    restart: always
    ports:
      - '8025:80'

  #######
  # App #
  #######

  app:
    hostname: app.elao
    extends:
      file: ./docker.common-services.yaml
      service: app.template
    restart: always
    volumes:
      - ./php/app.ini:/etc/php/7.4/cli/conf.d/php.ini:ro
      - ./php/app.ini:/etc/php/7.4/fpm/conf.d/php.ini:ro
      - ./php/xdebug/${OS}.ini:/etc/php/7.4/fpm/conf.d/xdebug.ini:ro
      - ./php/fpm.conf:/etc/php/7.4/fpm/pool.d/zz-www.conf:ro
    links:
      - maildev

  app.webpack-dev:
    extends:
        file: ./docker.common-services.yaml
        service: app.template
    restart: always
    ports:
        - '8085:8085'
    command: make dev
