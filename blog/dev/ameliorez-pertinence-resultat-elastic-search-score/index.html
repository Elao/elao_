<!DOCTYPE html>
<html lang="fr" class="no-js">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Améliorez la pertinence de vos résultats ElasticSearch grâce au score</title>

        <!-- Favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="/elao_/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/elao_/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/elao_/favicon-16x16.png">
        <link rel="manifest" href="/elao_/site.webmanifest">
        <link rel="mask-icon" href="/elao_/safari-pinned-tab.svg" color="#ff4344">
        <link rel="shortcut icon" href="/elao_/favicon.ico">
        <meta name="msapplication-TileColor" content="#ff4344">
        <meta name="msapplication-config" content="/elao_/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">

                    <meta name="description" content="Améliorez la pertinence de vos résultats ElasticSearch grâce au score." />
            <link rel="canonical" href="https://elao.github.io/elao_/blog/dev/ameliorez-pertinence-resultat-elastic-search-score" />

            <!-- Open Graph / Facebook -->
            <meta property="og:title" content="Améliorez la pertinence de vos résultats ElasticSearch grâce au score" />
            <meta property="og:locale" content="fr" />
            <meta property="og:description" content="Améliorez la pertinence de vos résultats ElasticSearch grâce au score." />
            <meta property="og:url" content="https://elao.github.io/elao_/blog/dev/ameliorez-pertinence-resultat-elastic-search-score" />
            <meta property="og:site_name" content="elao_" />

                                        <meta property="og:image" content="https://elao.github.io/elao_/resized/content/images/blog/thumbnails/elasticsearch.png/f7b6764d6c1c71e77c09f5a8027a6c19.png">
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary_large_image">
            <meta property="twitter:title" content="Améliorez la pertinence de vos résultats ElasticSearch grâce au score">
            <meta property="twitter:description" content="Améliorez la pertinence de vos résultats ElasticSearch grâce au score.">
            <meta property="twitter:site" content="@elao">
            <meta property="twitter:creator" content="@elao">
                                        <meta property="twitter:image" content="https://elao.github.io/elao_/resized/content/images/blog/thumbnails/elasticsearch.png/84cda64feefc2c85e6dd25456cbc0447.png">
                            <link rel="alternate" type="application/rss+xml" href="/elao_/blog/rss.xml" title="Le blog de l'équipe d'Elao" />
        
                <script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "Améliorez la pertinence de vos résultats ElasticSearch grâce au score",
    "image": [
        "https://elao.github.io/elao_/blog/dev/content/images/blog/thumbnails/elasticsearch.png"
    ],
    "datePublished": "2017-04-27T00:00:00+00:00",
    "dateModified": "2017-04-27T00:00:00+00:00",
    "author": [
        {
            "@type": "Person",
            "name": "Maxime Colin",
            "url": "https://elao.github.io/elao_/equipe/mcolin"
        }
    ],
    "keywords": [
        "Moteur de recherche",
        "Elasticsearch",
        "Pertinence",
        "Elastica"
    ]
}
    </script>
    
                            <meta name="robots" content="noindex" />
        
        <script>
                        document.querySelector('html').classList.remove('no-js');
        </script>

                    <link rel="stylesheet" href="/elao_/build/app.c8387912.css">
        
                        <script src="/elao_/build/runtime.c3b9d4eb.js" defer></script><script src="/elao_/build/552.3082ae9c.js" defer></script><script src="/elao_/build/769.7dfbbe52.js" defer></script><script src="/elao_/build/app.d906f729.js" defer></script>

                    

    <script src="https://platform.twitter.com/widgets.js"></script>
    <script async defer src="//platform.instagram.com/en_US/embeds.js"></script>

    <script>
        window.onload = (function(){
            var tweets = document.querySelectorAll('.tweet-container');
            tweets.forEach(function(tweet) {
                // https://developer.twitter.com/en/docs/twitter-for-websites/embedded-tweets/guides/embedded-tweet-parameter-reference
                twttr.widgets.createTweet(tweet.getAttribute('data-tweet-id'), tweet, {
                    conversation: 'none',
                    cards: 'hidden',
                    theme: 'light',
                    lang: 'fr',
                    align: 'center',
                    width: 550, // default
                    dnt: true,
                })
            })
        });
    </script>

        <!-- S.E.E. -->
        <meta name="see" content="&#x5B;&quot;&#x5C;&#x2F;elao_&#x5C;&#x2F;build&#x5C;&#x2F;see.ace7bf9f.js&quot;&#x5D;">
        <meta name="see_style" content="&#x5B;&quot;&#x5C;&#x2F;elao_&#x5C;&#x2F;build&#x5C;&#x2F;see.d77e78f8.css&quot;&#x5D;">
    </head>
    <body
        data-controller="swup-plugins symfony--ux-swup--swup swup-matomo" data-symfony--ux-swup--swup-containers-value="&#x5B;&quot;&#x23;main&quot;,&quot;&#x23;nav&quot;&#x5D;" data-symfony--ux-swup--swup-cache-value="true" data-symfony--ux-swup--swup-animate-history-browsing-value="true" data-symfony--ux-swup--swup-debug-value="false" data-symfony--ux-swup--swup-link-selector-value="a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&quot;&#x5D;&#x3A;not&#x28;&#x5B;data-no-swup&#x5D;&#x29;&#x3A;not&#x28;&#x5B;target&#x3D;&quot;_blank&quot;&#x5D;&#x29;&#x3A;not&#x28;a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;_profiler&quot;&#x5D;&#x29;,a&#x5B;href&#x5E;&#x3D;&quot;&#x2F;&quot;&#x5D;&#x3A;not&#x28;&#x5B;data-no-swup&#x5D;&#x29;&#x3A;not&#x28;&#x5B;target&#x3D;&quot;_blank&quot;&#x5D;&#x29;&#x3A;not&#x28;a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;_profiler&quot;&#x5D;&#x29;" data-swup-matomo-enabled-value="false">
                    <header id="nav" class="header">
                <div class="container">
                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/">
                        <span class="screen-reader">Améliorez la pertinence de vos résultats ElasticSearch grâce au score</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>

                                            <!-- Desktop nav -->
                        <nav class="nav">
                            <ul>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/nos-services/">
                                                                                        <span>Services</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/demarche">
                                                                                        <span>Démarche</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/etudes-de-cas">
                                                                                        <span>Études de cas</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/nos-valeurs">
                                                                                        <span>Valeurs</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/equipe">
                                                                                        <span>L&#039;équipe</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item nav__item--active">
                                        <a href="/elao_/blog">
                                                                                        <span>Blog</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/contact">
                                                                                            <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                        <span>Contact</span>
                                        </a>
                                    </li>
                                                            </ul>
                        </nav>
                    
                                            <!-- Mobile nav -->
                        <nav class="nav-mobile" data-controller="toggle">
                            <div class="nav-mobile__header">
                                <a href="/elao_/">
                                                                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                                </a>
                                <button class="nav-toggle nav-toggle--close">
                                    <i class="icon icon--close" aria-hidden="true"></i>
                                    <span class="screen-reader">Fermer le menu</span>
                                </button>
                            </div>
                            <ul>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/nos-services/">
                                                                                        <span>Services</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/demarche">
                                                                                        <span>Démarche</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/etudes-de-cas">
                                                                                        <span>Études de cas</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/nos-valeurs">
                                                                                        <span>Valeurs</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/equipe">
                                                                                        <span>L&#039;équipe</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item nav-mobile__item--active ">
                                        <a href="/elao_/blog">
                                                                                        <span>Blog</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  nav-mobile__item--large">
                                        <a href="/elao_/contact">
                                                                                            <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                        <span>Contact</span>
                                        </a>
                                    </li>
                                                            </ul>
                        </nav>
                        <button class="nav-toggle nav-toggle--open">
                            <i class="icon icon--hamburger" aria-hidden="true"></i>
                            <span class="screen-reader">Ouvrir le menu</span>
                        </button>
                                    </div>
            </header>
                <main id="main">
                <div class="container">
                                <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
            <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/">
                <span itemprop="name">Accueil</span>
            </a>
            <meta itemprop="position" content="1" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/blog">
                <span itemprop="name">Blog</span>
            </a>
            <meta itemprop="position" content="2" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/blog/dev">
                <span itemprop="name">Dev</span>
            </a>
            <meta itemprop="position" content="3" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="#">
                <span itemprop="name">Améliorez la pertinence de vos résultats ElasticSearch grâce au score</span>
            </a>
            <meta itemprop="position" content="4" />
        </li></ol>

        
        <div class="article-banner">
            <div class="article-banner__cover" style="background: #f1f1f1 url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/8372db92345877cb0615b2731ee29f89.jpg');
    background: #f1f1f1 -webkit-image-set(
        url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/8372db92345877cb0615b2731ee29f89.jpg') 1x,
        url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/a21e6b2bfed4a3053081d1693283aa81.jpg') 2x
    );
    background: #f1f1f1 -moz-image-set(
        url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/8372db92345877cb0615b2731ee29f89.jpg') 1x,
        url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/a21e6b2bfed4a3053081d1693283aa81.jpg') 2x
    );
    background: #f1f1f1 -ms-image-set(
        url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/8372db92345877cb0615b2731ee29f89.jpg') 1x,
        url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/a21e6b2bfed4a3053081d1693283aa81.jpg') 2x
    );
    background: #f1f1f1 image-set(
        url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/8372db92345877cb0615b2731ee29f89.jpg') 1x,
        url('/elao_/resized/content/images/blog/headers/elasticsearch.jpg/a21e6b2bfed4a3053081d1693283aa81.jpg') 2x
    );" data-aos="fade-down"></div>

            <div class="article-info" data-aos="zoom-in">
                                                    <div class="article-author ">
                        <div class="article-author__image">
                                                            <a href="/elao_/blog/auteur/mcolin">
                                    <img     src="/elao_/resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg"
    srcset="
        /elao_/resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg 1x,
        /elao_/resized/content/images/members/avatars/mcolin.jpg/0899bdf7169af336de983de73d88fa58.jpg 2x
    "
 />
                                </a>
                                                    </div>
                        <span class="article-author__info">
                            Écrit par
                                                            <a href="/elao_/blog/auteur/mcolin">
                                    <strong>Maxime Colin</strong>
                                </a>
                                                    </span>
                    </div>
                                <div class="article-info__date">
                    <span>Publication <strong>27 avril 2017</strong></span>
                                                        </div>
            </div>

            <div class="article-header" data-aos="zoom-in-up">
                <h1>Améliorez la pertinence de vos résultats ElasticSearch grâce au score</h1>
                <p>Améliorez la pertinence de vos résultats ElasticSearch grâce au score.</p>
                <ul class="article-tag-list">
                                            <li class="article-tag-list__item">
                            <a href="/elao_/blog/tag/moteur-de-recherche" rel="nofollow">#MoteurDeRecherche</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/blog/tag/elasticsearch" rel="nofollow">#Elasticsearch</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/blog/tag/pertinence" rel="nofollow">#Pertinence</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/blog/tag/elastica" rel="nofollow">#Elastica</a>
                        </li>
                                    </ul>
            </div>
        </div>

                    <ol class="table-of-content" data-aos="fade-up">
                                    <li class="table-of-content__item">
                        <a href="#elasticsearch">ElasticSearch</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#une-histoire-de-score">Une histoire de score</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#indexation">Indexation</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#requeter">Requêter</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#conclusion">Conclusion</a>

                                            </li>
                            </ol>
        
        <div class="article-content">
            <main class="article-content__main">

                
                
                <h2 id="elasticsearch" class="anchor-title"><a href="#elasticsearch">ElasticSearch</a></h2>
<p><a href="https://www.elastic.co/fr/products/elasticsearch" target="_blank">ElasticSearch</a> est un moteur de recherche très puissant mais relativement simple à mettre en place et à intégrer grâce à son API RESTful. Des bibliothèques telles que le client PHP <a href="http://elastica.io/" target="_blank">Elastica</a> et le bundle Symfony <a href="https://github.com/FriendsOfSymfony/FOSElasticaBundle" target="_blank">FOSElasticaBundle</a> facilitent encore plus son intégration. Néanmoins la configuration fine du moteur de recherche reste assez complexe et peut faire peur au premier abord.</p>
<p>Je ne vais pas parler de la configuration serveur et infrastructure d'ElasticSearch qui touche plus aux performances et à la sécurité de l'outil mais plutôt m'attarder sur la configuration du moteur de recherche en lui-même, de ce qui impactera la pertinence de vos résultats.</p>
<p>Deux choses vont impacter les résultats de vos recherches : l'<strong>indexation</strong> de vos données et vos <strong>requêtes</strong> de recherche. Ce sont donc ces deux points qui vont être abordés dans cet article.</p>
<h2 id="une-histoire-de-score" class="anchor-title"><a href="#une-histoire-de-score">Une histoire de score</a></h2>
<p>Lors d'une recherche ElasticSearch, un score est calculé pour chaque document du résultat. Ce score est censé représenter la pertinence du document afin de pouvoir ordonner les résultats. Néanmoins il ne représente que la pertinence des résultats face aux paramètres de la recherche et d'indexation.</p>
<p>Pour calculer ce score, ElasticSearch va s'appuyer sur trois critères :</p>
<ul>
<li>La <strong>fréquence du terme</strong> recherché dans le document. Plus le terme est fréquent, plus son poids sera élevé.</li>
<li>La <strong>fréquence inverse du terme</strong> à travers tous les documents. Plus le terme est fréquent, moins il aura de poids.</li>
<li>La <strong>longueur du champ</strong>. Plus le champ est grand, plus le poids sera faible ; inversement, plus le champ est petit, plus le poids sera élevé.</li>
</ul>
<p>Par defaut, ElasticSearch combine ces 3 règles pour obtenir un score, mais certaines peuvent être désactivées si elles ne vous semblent pas correspondre à vos données. Pour plus d'informations sur le calcul du score, lisez la <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/scoring-theory.html" target="_blank">théorie du score</a> sur le site d'ElasticSearch.</p>
<p>Ces règles permettent déjà d'avoir une bonne notion de pertinence mais restent assez simples et ne prennent pas en compte le métier de vos données. Pour ajouter plus de logique dans les scores, vous devrez introduire vos propres règles qui influenceront voire remplaceront le score.</p>
<h2 id="indexation" class="anchor-title"><a href="#indexation">Indexation</a></h2>
<p>L'indexation est la première étape lorsque qu'il s'agit d'optimiser la pertinence de son moteur de recherche. Car c'est grâce aux données indéxées qu'ElasticSearch va calculer les scores.</p>
<h3 id="typage" class="anchor-title"><a href="#typage">Typage</a></h3>
<p>ElasticSearch propose un <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html" target="_blank">large choix de types</a> pour vos données. Il a de nombreux types spéciaux qui n'existent pas dans les languages de programmation tels que <code class="code-inline" id="e666f0e0a0c7f28f4cf3cd66c882a888">geo_point</code> ou <code class="code-inline" id="957b527bcfbad2e80f58d20683931435">ip</code>. Il est important de typer correctement ses données car ElasticSearch dispose de traitements optimisés pour chaque type.</p>
<h3 id="analyser" class="anchor-title"><a href="#analyser">Analyser</a></h3>
<p>L'<code class="code-inline" id="b43bf56130ef201d20e437829192ea14">analyser</code> est chargé d'examiner les données a indéxer afin de les stocker de la façon la plus optimale pour les recherches. Cette partie est très importante car des données mal indéxées ne permettront pas une recherche pertinente. Il faut donc choisir avec soin l'<code class="code-inline" id="b43bf56130ef201d20e437829192ea14">analyser</code> pour chaque type de donnée que vous souhaitez indéxer. Ce choix est d'autant plus important pour les données complexes telles qu'un texte.</p>
<p>ElasticSearch propose <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" target="_blank">plusieurs <code class="code-inline" id="505c039011caaa109aeba3cec287a678">analysers</code></a> configurables. Chaque <code class="code-inline" id="d07d1da44efa33dae6b0debbc593c92d">analyzer</code> est une combinaison d'un <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html" target="_blank"><code class="code-inline" id="df65931bf434e4e24dd3e4fd2a7f4473">tokeniser</code></a> chargé de découper votre donnée en tokens, de <code class="code-inline" id="8fc26d630c4135fd646f74409a7c5a73">char filters</code> chargés de filtrer les caractères et de <code class="code-inline" id="23d0b829a1ce78ea51550ed697149617">token filters</code> chargés de filtrer les tokens.</p>
<p>Vous pouvez également <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-custom-analyzer.html" target="_blank">créer votre propre <code class="code-inline" id="d07d1da44efa33dae6b0debbc593c92d">analyzer</code></a> en combinant vous-même <code class="code-inline" id="df65931bf434e4e24dd3e4fd2a7f4473">tokeniser</code>, <code class="code-inline" id="8fc26d630c4135fd646f74409a7c5a73">char filters</code> et <code class="code-inline" id="23d0b829a1ce78ea51550ed697149617">token filters</code>. Pour configurer un moteur de recherche efficace, il est donc recommandé de choisir ou créer un <code class="code-inline" id="b43bf56130ef201d20e437829192ea14">analyser</code> adapté à chacune des données indéxées.</p>
<p>Par exemple, pour obtenir une indexation efficace d'un texte, il existe quelques filtres très importants à mettre en place :</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-stemmer-tokenfilter.html#analysis-stemmer-tokenfilter" target="_blank"><code class="code-inline" id="fce9c62d39c833a8144ab45f9005aa9e">stemmer</code></a> : Permet une analyse linguistique de votre texte basée sur les racines des mots dans une langue donnée (une recherche sur le mot "collection" trouvera ainsi les mots "collectionner" ou "collectionneur" par exemple).</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-stop-tokenfilter.html" target="_blank"><code class="code-inline" id="ef399b2d446bb37b7c32ad2cc1b6045b">stop</code></a> : Permet de filtrer les <em>stop words</em>, c'est-à-dire les mots de liaison qui ne sont pas porteurs de sens et qui ne feraient que polluer l'index (en français par exemple : "de", "en", "à", "le", "la", ...).</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-keyword-marker-tokenfilter.html" target="_blank"><code class="code-inline" id="14e175572c79c13b7537e47267efb05b">keyword_marker</code></a> : Permet d'indiquer des mots clés à considérer comme un seul token et non comme plusieurs mots (par exemple "service worker" ou "sous domaine" sont des mots clés).</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-lowercase-tokenfilter.html" target="_blank"><code class="code-inline" id="f82413ecc07fb74bf40ccfe963a5c4b6">lowercase</code></a> : Permet de tout indexer en <em>lowercase</em> afin de ne pas être sensible à la casse.</li>
</ul>
<p>Il existe bien évidemment <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-lang-analyzer.html#french-analyzer" target="_blank">des <code class="code-inline" id="505c039011caaa109aeba3cec287a678">analysers</code> par langue déjà prêts à l'emploi</a>, mais l'idée est de vous montrer qu'il est important de bien indiquer à <strong>ElasticSearch</strong> comment analyser vos données.</p>
<h3 id="boost" class="anchor-title"><a href="#boost">Boost</a></h3>
<p>Vous pouvez ajouter dans votre mapping des <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-boost.html" target="_blank">boost</a> sur certaines propriétés afin de privilégier automatiquement ces propriétés lors du calcul de pertinence.</p>
<div class="tabs">
<div class="tabs__nav">
  <a href="#mapping-boost-json" class="active">json</a>
  <a href="#mapping-boost-yaml">yaml</a>
</div>

<div class="tabs__content">
<div class="item active" id="mapping-boost-json">
<pre class="language-json">
<code class="language-json" id="aadb47214e407b79fba4d287cf8f310c"><span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"article"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
          <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code>
</pre>
</div>
<div class="item" id="mapping-boost-yaml">
<pre class="language-yaml">
<code class="language-yaml" id="4a60445c9deb2238571534f2b1c0b20f"><span class="token key atrule">fos_elastica</span><span class="token punctuation">:</span>
  <span class="token key atrule">indexes</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span>
      <span class="token key atrule">types</span><span class="token punctuation">:</span>
        <span class="token key atrule">article</span><span class="token punctuation">:</span>
          <span class="token key atrule">mappings</span><span class="token punctuation">:</span>
            <span class="token key atrule">title</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span> <span class="token key atrule">analyzer</span><span class="token punctuation">:</span> my_analyzer<span class="token punctuation">,</span> <span class="token key atrule">boost</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span>
            <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">analyzer</span><span class="token punctuation">:</span> my_analyzer <span class="token punctuation">}</span></code>
</pre>
</div>
</div>
</div>
<p>Dans cet exemple, le titre aura 3 fois plus de poids que le contenu lors du calcul de pertinence.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>
    Les <code class="code-inline" id="100888b93fa9f3820b482ad26f3a4cfd">boosts</code> indiqués au <code class="code-inline" id="f84f4a69bdc03d4a4251db12ee746ce3">mapping</code> ne fonctionneront que sur les requêtes de type <code class="code-inline" id="b4dad0fe5fbef2c0e24d9db1cc69e5a2">term</code>. Pour les requêtes de type <code class="code-inline" id="37b19816109a32106d109e83bbb3c97d">range</code> ou <code class="code-inline" id="e3cc92c14a5e6dd1a7d94b6ff634d7fc">match</code> par exemple, il faudra préciser les <code class="code-inline" id="100888b93fa9f3820b482ad26f3a4cfd">boosts</code> dans la requête comme expliqué dans la suite de l'article.
</p>
</div>
<h2 id="requeter" class="anchor-title"><a href="#requeter">Requêter</a></h2>
<h3 id="analyzer" class="anchor-title"><a href="#analyzer">Analyzer</a></h3>
<p>Pour utiliser votre <code class="code-inline" id="b43bf56130ef201d20e437829192ea14">analyser</code> lors de la recherche, vous devez le préciser dans votre requête. Vous pouvez compléter votre requête avec les options <code class="code-inline" id="b4160057229b3295e34dce5a9618e79f">fuzziness</code> et <code class="code-inline" id="091b68ba08a375c70c7bc1eafbe1af90">minimum_should_match</code>.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-minimum-should-match.html" target="_blank"><code class="code-inline" id="091b68ba08a375c70c7bc1eafbe1af90">minimum_should_match</code></a> permet d'indiquer le pourcentage minimum de votre recherche qui doit être trouvé dans vos documents.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#fuzziness" target="_blank"><code class="code-inline" id="b4160057229b3295e34dce5a9618e79f">fuzziness</code></a> permet de rechercher des termes malgré des fautes de frappe (inversion de lettre, lettre manquante, ...) en utilisant la <a href="https://fr.wikipedia.org/wiki/Distance_de_Levenshtein" target="_blank">Distance de Levenshtein</a>.</p>
<p>Les scores des résultats seront bien évidemment impactés par ces options.</p>
<div class="tabs">
<div class="tabs__nav">
  <a href="#query-analyzer-json" class="active">json</a>
  <a href="#query-analyzer-php">php</a>
</div>
<div class="tabs__content">
<div class="item active" id="query-analyzer-json">
<pre class="language-json">
<code class="language-json" id="7f0e38e3693bc85dc2c928b22a4342e2"><span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Foobar"</span><span class="token punctuation">,</span>
            <span class="token property">"analyser"</span><span class="token operator">:</span> <span class="token string">"my_analyser"</span><span class="token punctuation">,</span>
            <span class="token property">"fuzziness"</span><span class="token operator">:</span> <span class="token string">"AUTO"</span><span class="token punctuation">,</span>
            <span class="token property">"minimum_should_match"</span><span class="token operator">:</span> <span class="token string">"70%"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code>
</pre>
</div>
<div class="item" id="query-analyzer-php">
<pre class="language-php">
<code class="language-php" id="88553ba8db4286a4ae8ab3e6b1d98654"><span class="token function">setFieldQuery</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'title'</span><span class="token punctuation">,</span> <span class="token variable">$search</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setFieldAnalyzer</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'title'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'my_analyzer'</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setFieldFuzziness</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'title'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'AUTO'</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setFieldMinimumShouldMatch</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'title'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'70%'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code>
</pre>
</div>
</div>
</div>
<h3 id="boost" class="anchor-title"><a href="#boost">Boost</a></h3>
<p>Les <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_boosting_query_clauses.html" target="_blank"><code class="code-inline" id="99d6df7b870935548ca9349c37ad45b7">boost</code></a> permettent également d'augmenter le poids d'une clause de votre rêquete. Plus le boost est élevé, plus votre clause pèsera sur le score.</p>
<p>Dans l'exemple suivant, nous faisons une recherche de la chaine <code class="code-inline" id="89d5739baabbbe65be35cbe61c88e06d">Foobar</code> sur un document ayant un titre et un contenu. Grâce aux <code class="code-inline" id="99d6df7b870935548ca9349c37ad45b7">boost</code> nous pouvons donner plus d'importance aux titres qu'aux contenus.</p>
<div class="tabs">
<div class="tabs__nav">
  <a href="#boost-json" class="active">json</a>
  <a href="#boost-php">php</a>
</div>
<div class="tabs__content">
<div class="item active" id="boost-json">
<pre class="language-json">
<code class="language-json" id="04672654d7a530987ea45a2db68fec22"><span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"should"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Foobar"</span><span class="token punctuation">,</span> <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Foobar"</span><span class="token punctuation">,</span> <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code>
</pre>
</div>
<div class="item" id="boost-php">
<pre class="language-php">
<code class="language-php" id="56ffd820b56db9ad2dbf14b51a6394df"><span class="token function">addShould</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Query<span class="token punctuation">\</span>Match</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setFieldQuery</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'title'</span><span class="token punctuation">,</span> <span class="token variable">$search</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setFieldBoost</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'title'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">addShould</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Query<span class="token punctuation">\</span>Match</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setFieldQuery</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">,</span> <span class="token variable">$search</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setFieldBoost</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code>
</pre>
</div>
</div>
</div>
<p>Vous pouvez également utiliser plusieurs <code class="code-inline" id="99d6df7b870935548ca9349c37ad45b7">boost</code> sur la même propriété mais avec plusieurs valeurs afin d'augmenter le score par palier.</p>
<div class="tabs">
<div class="tabs__nav">
  <a href="#boost-step-json" class="active">json</a>
  <a href="#boost-step-php">php</a>
</div>
<div class="tabs__content">
<div class="item active" id="boost-step-json">
<pre class="language-json">
<code class="language-json" id="7068156bb700a0e649151a25cbae1d31"><span class="token punctuation">{</span>
  <span class="token property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"bool"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"should"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"range"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"publishedAt"</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"boost"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">"gte"</span> <span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"range"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"publishedAt"</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"boost"</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">"gte"</span> <span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"range"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"publishedAt"</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"boost"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"gte"</span> <span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code>
</pre>
</div>
<div class="item" id="boost-step-php">
<pre class="language-php">
<code class="language-php" id="adddd9b8955b0f4732967ba8f1a3e0a4"><span class="token function">addShould</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Query<span class="token punctuation">\</span>Range</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'publishedAt'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'boost'</span> <span class="token operator">=&gt;</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'gte'</span>   <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DateTime</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'-1 month'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">addShould</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Query<span class="token punctuation">\</span>Range</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'publishedAt'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'boost'</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'gte'</span>   <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DateTime</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'-2 months'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">addShould</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Query<span class="token punctuation">\</span>Range</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'publishedAt'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'boost'</span> <span class="token operator">=&gt;</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'gte'</span>   <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DateTime</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'-3 months'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code>
</pre>
</div>
</div>
</div>
<h3 id="les-fonctions-de-score" class="anchor-title"><a href="#les-fonctions-de-score">Les fonctions de score</a></h3>
<p>Les fonctions de score permettent de modifier le score de vos résultats.</p>
<p>Il existe plusieurs types de fonctions de score :</p>
<ul>
<li><code class="code-inline" id="c0d970d59d173f0eb4e832a989fe82b2">script_score</code></li>
<li><code class="code-inline" id="7edabf994b76a00cbc60c95af337db8f">weight</code></li>
<li><code class="code-inline" id="a128fd93e7dc00454086b733fc10abf3">random_score</code></li>
<li><code class="code-inline" id="fb6f378b0f8be7fac90fa554969399d0">field_value_factor</code></li>
<li><code class="code-inline" id="35bf203ff7274404dd26f5ec06d4cb15">decay functions</code></li>
</ul>
<p>Je vais surtout détailler les fonctions <code class="code-inline" id="3205c0ded576131ea255ad2bd38b0fb2">script</code> et <code class="code-inline" id="63faabca234a29640f3344e74c0672da">decay</code> car ce sont celles qui permettent le plus d'implémenter une logique de pertinence. Pour les autres vous pouvez lire <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#score-functions" target="_blank">la documentation sur les fonctions de score</a>.</p>
<h4 id="les-scripts-de-score" class="anchor-title"><a href="#les-scripts-de-score">Les scripts de score</a></h4>
<p>Les scripts de score (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score" target="_blank"><code class="code-inline" id="c0d970d59d173f0eb4e832a989fe82b2">script_score</code></a>) vous permettent de modifier le score de vos résultats à partir d'un script ou d'une formule de votre choix. Vous avez accès au document dont vous modifiez le score et pouvez donc utiliser l'une de ses propriétés dans le calcul. <code class="code-inline" id="94051e850d51ff2bd7aca7151d3561f8">_score</code> est une variable qui contient le score original.</p>
<div class="tabs">
<div class="tabs__nav">
  <a href="#script-functions-json" class="active">json</a>
  <a href="#script-functions-php">php</a>
</div>
<div class="tabs__content">
<div class="item active" id="script-functions-json">
<pre class="language-json">
<code class="language-json" id="04b0726dbd3bccfed810fdde6261296f"><span class="token punctuation">{</span>
    <span class="token property">"script_score"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"script"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"lang"</span><span class="token operator">:</span> <span class="token string">"painless"</span><span class="token punctuation">,</span>
          <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token string">"_score * doc['my_numeric_field'].value"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code>
</pre>
</div>
<div class="item" id="script-functions-php">
<pre class="language-php">
<code class="language-php" id="e7fcd60c764c9cbfe08b0874f877b4c6"><span class="token function">addScriptScoreFunction</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Elastica<span class="token punctuation">\</span>Script</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"_score * doc['my_numeric_field'].value"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$score</span><span class="token operator">-&gt;</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token variable">$bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token variable">$score</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code>
</pre>
</div>
</div>
</div>
<p>Vous pouvez ainsi utiliser une valeur ou une formule métier pour calculer la pertinence de vos résultats.</p>
<h4 id="facteur" class="anchor-title"><a href="#facteur">Facteur</a></h4>
<p>Cette fonction de score (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-field-value-factor" target="_blank"><code class="code-inline" id="fb6f378b0f8be7fac90fa554969399d0">field_value_factor</code></a>) vous permet d'appliquer un facteur de multiplication (<code class="code-inline" id="742f32c65ffd18b766fa307f8de2d47d">factor</code>), une valeur par defaut (<code class="code-inline" id="ea21841da70e6405af19fabc4ff8bdd9">missing</code>) ainsi qu'une fonction mathématique (<code class="code-inline" id="3ad7320fa61b1cfad6b5a97fcb565315">modifier</code>) à une propriété de votre document. Plusieurs fonctions mathématiques sont disponibles (<code class="code-inline" id="dc1d71bbb5c4d2a5e936db79ef10c19f">log</code>, <code class="code-inline" id="dd1de98e8b0e34d5cf5396e83036f4d5">sqrt</code>, <code class="code-inline" id="f8e19f449f17c9d37dcc93dd244ec3bb">ln</code>, ...).</p>
<div class="tabs">
<div class="tabs__nav">
  <a href="#factor-functions-json" class="active">json</a>
  <a href="#factor-functions-php">php</a>
</div>
<div class="tabs__content">
<div class="item active" id="factor-functions-json">
<pre class="language-json">
<code class="language-json" id="ecf5aaa9d25f8c3fe8b012140419ef47"><span class="token punctuation">{</span>
    <span class="token property">"field_value_factor"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"rate"</span><span class="token punctuation">,</span>
        <span class="token property">"factor"</span><span class="token operator">:</span> <span class="token number">1.1</span><span class="token punctuation">,</span>
        <span class="token property">"modifier"</span><span class="token operator">:</span> <span class="token string">"sqrt"</span><span class="token punctuation">,</span>
        <span class="token property">"missing"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code>
</pre>
</div>
<div class="item" id="factor-functions-php">
<pre class="language-php">
<code class="language-php" id="9958daacb636fb0f0ab6b5c150f23884"><span class="token function">addFieldValueFactorFunction</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'rate'</span><span class="token punctuation">,</span>
    <span class="token number">1.1</span><span class="token punctuation">,</span>
    <span class="token scope">Query<span class="token punctuation">\</span>FunctionScore<span class="token punctuation">::</span></span><span class="token constant">FIELD_VALUE_FACTOR_MODIFIER_SQRT</span><span class="token punctuation">,</span>
    <span class="token number">1</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$score</span><span class="token operator">-&gt;</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token variable">$bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token variable">$score</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code>
</pre>
</div>
</div>
</div>
<p>Dans cet exemple, la pertinence d'un résultat repose sur la note du document via la formule suivante : <code class="code-inline" id="ac7021b97cb43f55588beffe0da83ba5">sqrt(1.1 * doc.rate)</code>.</p>
<h4 id="les-fonctions-de-decroissance" class="anchor-title"><a href="#les-fonctions-de-decroissance">Les fonctions de décroissance</a></h4>
<p>Les fonctions de décroissance (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-decay" target="_blank"><code class="code-inline" id="18e62ab37e43c39ac5759a0c39b2baf6">decay function</code></a>) sont une autre méthode pour modifier le score de vos résultats. Elles se basent sur des fonctions mathématiques pour réduire le score de vos résultats.</p>
<div class="tabs">
<div class="tabs__nav">
  <a href="#decay-functions-json" class="active">json</a>
  <a href="#decay-functions-php">php</a>
</div>
<div class="tabs__content">
<div class="item active" id="decay-functions-json">
<pre class="language-json">
<code class="language-json" id="29bd04b7a69de43077b3fe8e180d0539"><span class="token punctuation">{</span>
    <span class="token property">"DECAY_FUNCTION"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"FIELD_NAME"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"origin"</span><span class="token operator">:</span> <span class="token string">"2017-04-24"</span><span class="token punctuation">,</span>
              <span class="token property">"offset"</span><span class="token operator">:</span> <span class="token string">"1d"</span><span class="token punctuation">,</span>
              <span class="token property">"scale"</span><span class="token operator">:</span> <span class="token string">"5d"</span><span class="token punctuation">,</span>
              <span class="token property">"decay"</span><span class="token operator">:</span> <span class="token number">0.5</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code>
</pre>
</div>
<div class="item" id="decay-functions-php">
<pre class="language-php">
<code class="language-php" id="11eb5b53b9229e8f50fffaa2ba41f37c"><span class="token function">addDecayFunction</span><span class="token punctuation">(</span>
    <span class="token scope">Query<span class="token punctuation">\</span>FunctionScore<span class="token punctuation">::</span></span><span class="token constant">DECAY_LINEAR</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'publishedAt'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'2017-04-24'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'5d'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'1d'</span><span class="token punctuation">,</span>
    <span class="token number">0.90</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$score</span><span class="token operator">-&gt;</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token variable">$bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token variable">$score</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code>
</pre>
</div>
</div>
</div>
<p>Chaque fonction de décroissance est caratérisée par les propriétés <code class="code-inline" id="7c49b153d4b59f8c0cf8c3e18dc80cb7">origin</code>, <code class="code-inline" id="7a86c157ee9713c34fbd7a1ee40f0c5a">offset</code>, <code class="code-inline" id="0cb47aeb6e5f9323f0969e628c4e59f5">scale</code> et <code class="code-inline" id="63faabca234a29640f3344e74c0672da">decay</code>.</p>
<ul>
<li><code class="code-inline" id="7c49b153d4b59f8c0cf8c3e18dc80cb7">origin</code> est la valeur centrale à partir de laquelle sera calculée la distance de vos résultats. D'une manière générale, plus vos résultats s'éloigneront de cette valeur centrale, plus le score sera réduit.</li>
<li><code class="code-inline" id="7a86c157ee9713c34fbd7a1ee40f0c5a">offset</code> est la distance à partir de laquelle s'appliquera votre fonction de décroissance. Avant cette distance le score ne sera pas modifié.</li>
<li><code class="code-inline" id="0cb47aeb6e5f9323f0969e628c4e59f5">scale</code> est la valeur à laquelle votre fonction de décroissance appliquera la réduction souhaitée.</li>
<li><code class="code-inline" id="63faabca234a29640f3344e74c0672da">decay</code> est la valeur de réduction de score souhaitée (pourcentage de 0 à 1).</li>
</ul>
<p>Dans l'exemple ci-dessus, la valeur centrale est le 24 avril 2017 et on souhaite qu'à 6 jours (1 jour d'offset + 5 jours de scale) de cette date, soit le 18 et le 30 avril, le score soit réduit de moitié. La réduction du score des autres résultats sera calculée par la fonction de décroissance choisie.</p>
<p>Il existe 3 fonctions de décroissances, <a href="https://fr.wikipedia.org/wiki/Fonction_lin%C3%A9aire" target="_blank">linéaire</a>, <a href="https://fr.wikipedia.org/wiki/Fonction_exponentielle" target="_blank">exponentielle</a> et <a href="https://fr.wikipedia.org/wiki/Fonction_gaussienne" target="_blank">gaussienne</a>.</p>
<p>La fonction linéaire est une droite, la décroissance est proportionelle à la distance. Avec la fonction exponentielle, la décroissance est très forte au début et diminue rapidement avec la distance jusqu'à tendre vers zero. Avec la fonction gaussienne, la décroissance est également très forte au début mais diminue moins rapidement.</p>
<img src="/elao_/resized/content/images/blog/2017/es-decay-graph.png/b383917116e80471ea886712ab793b85.png" alt="Decay functions" title="Decay functions" srcset="/elao_/resized/content/images/blog/2017/es-decay-graph.png/b383917116e80471ea886712ab793b85.png 1x,
/elao_/resized/content/images/blog/2017/es-decay-graph.png/5f1a8c3be10f20c35bc3bb987bacab9e.png 2x," id="decay-functions">
<p>Les fonctions de décroissance peuvent être appliquées sur des valeurs numériques, des dates (<code class="code-inline" id="7a86c157ee9713c34fbd7a1ee40f0c5a">offset</code> et <code class="code-inline" id="0cb47aeb6e5f9323f0969e628c4e59f5">scale</code> sont alors exprimés en durée : 5h ou 1d par exemple) ou des géopoints (<code class="code-inline" id="7a86c157ee9713c34fbd7a1ee40f0c5a">offset</code> et <code class="code-inline" id="0cb47aeb6e5f9323f0969e628c4e59f5">scale</code> sont alors exprimés en distance : 100m ou 5km par exemple).</p>
<h2 id="conclusion" class="anchor-title"><a href="#conclusion">Conclusion</a></h2>
<p>Avec toutes ces fonctionnalités, vous dévriez être capables de gérer la pertinence de votre moteur de recherche assez finement. Attention néanmoins, cet article n'est pas exhaustif, <strong>ElasticSearch</strong> propose bien d'autres possibilités.</p>
<p>L'important est de ne pas se limiter à la configuration de base et d'adapter l'algorithme de score à vos données et vos besoins.</p>
<script type="text/javascript">
    function Tabs (element)
    {
        this.element = element;
        this.links   = element.querySelectorAll('.tabs__nav a');
        this.tabs    = element.querySelectorAll('.tabs__content .item');

        [].forEach.call(this.links, function (link) {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                this.open(link);
            }.bind(this));
        }.bind(this));
    }

    Tabs.prototype.open = function (link)
    {
        [].forEach.call(this.links, function (link) { link.classList.remove('active'); });
        [].forEach.call(this.tabs, function (tab) { tab.classList.remove('active'); });

        link.classList.add('active');
        this.element.querySelector(link.getAttribute('href')).classList.add('active');
    };

    [].forEach.call(document.querySelectorAll('.tabs'), function (element) { new Tabs(element); });
</script>
                                                                </main>
            <aside class="article-content__aside">
                            </aside>
        </div>

        <div class="article-footer" data-aos="fade-in">
                                                <div class="article-author">
                        <div class="article-author__image">
                            <a href="/elao_/blog/auteur/mcolin">
                                <img     src="/elao_/resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg"
    srcset="
        /elao_/resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg 1x,
        /elao_/resized/content/images/members/avatars/mcolin.jpg/0899bdf7169af336de983de73d88fa58.jpg 2x
    "
 />
                            </a>
                        </div>
                        <span class="article-author__info">
                            Écrit par
                            <a href="/elao_/blog/auteur/mcolin">
                                <strong>Maxime Colin</strong>
                            </a>
                        </span>

                        <div class="article-author__social">
                                                            <a href="https://twitter.com/colin_maxime" class="social social--small">
                                    <i class="icon icon--x" aria-hidden="true"></i>
                                    <span class="screen-reader">Compte Twitter de Maxime Colin</span>
                                </a>
                                                                                        <a href="https://github.com/maximecolin " class="social social--small">
                                    <i class="icon icon--github" aria-hidden="true"></i>
                                    <span class="screen-reader">Compte github de Maxime Colin</span>
                                </a>
                                                                                        <a href="https://www.maximecolin.fr/" class="social social--small">
                                    <i class="icon icon--website" aria-hidden="true"></i>
                                    <span class="screen-reader">Site personnel de Maxime Colin</span>
                                </a>
                                                    </div>
                    </div>
                                    </div>

                <div class="bricks">
            
                            <div class="brick-contribute">
                    <p>
                        Une typo ?
                        <a href="https://github.com/Elao/elao_/edit/master/content/blog/dev/ameliorez-pertinence-resultat-elastic-search-score.md/" target="_blank" class="animated-link animated-link--light">
                            Modifier cet article sur Github
                        </a>
                    </p>
                </div>
                    </div>
            </div>
        </main>
                    
<footer class="footer">
    <div class="container">
        <section class="footer__links">
            <p class="h1">
                elao
                <span>développe</span>
                <span>du lien</span>
            </p>
            <div class="links">
                                    <ul>
                                                    <li>
                                <a href="/elao_/nos-services/" >Services</a>
                            </li>
                                                    <li>
                                <a href="/elao_/demarche" >Démarche</a>
                            </li>
                                                    <li>
                                <a href="/elao_/etudes-de-cas" >Études de cas</a>
                            </li>
                                            </ul>
                                    <ul>
                                                    <li>
                                <a href="/elao_/nos-valeurs" >Valeurs</a>
                            </li>
                                                    <li>
                                <a href="/elao_/equipe" >L&#039;équipe</a>
                            </li>
                                                    <li>
                                <a href="/elao_/blog" >Blog</a>
                            </li>
                                                    <li>
                                <a href="/elao_/blog/rss.xml"  data-no-swup="data-no-swup">RSS</a>
                            </li>
                                            </ul>
                                <ul>
                    <li>
                                                <a href="/elao_/recrutement">
                            Nous recrutons
                                                            <span class="bullet">2</span>
                                                    </a>
                    </li>
                    <li>
                        <a href="/elao_/glossaire/">Glossaire 🧐</a>
                    </li>
                    <li>
                        <a href="/elao_/elaomojis">Elaomojis 🎉</a>
                    </li>
                </ul>
            </div>
            <div class="socials">
                <ul>
                    <li>
                        <a href="https://github.com/elao" target="_blank">
                            <i class="icon icon--github"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/elao" target="_blank">
                            <i class="icon icon--x"></i>
                            Twitter
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/company/elao/mycompany/" target="_blank">
                            <i class="icon icon--linkedin"></i>
                            Linkedin
                        </a>
                    </li>
                </ul>
            </div>
            <div class="contacts">
                <ul>
                    <li>
                        <a href="/elao_/contact">Contact</a>
                    </li>
                    <li>
                        <a href="tel:04 82 53 37 19">04 82 53 37 19</a>
                    </li>
                    <li>
                        <a href="mailto:contact@elao.com">contact@elao.com</a>
                    </li>
                    <li>34 rue Jean Broquin</li>
                    <li>69006 Lyon</li>
                </ul>
            </div>
        </section>

        <section class="footer__legals">
            <span>© 2005 - 2024 - ELAO - Tous droits réservés</span>
            <a href="/elao_/legal">Mentions légales</a>
            <a href="/elao_/confidentialite">Protection des données</a>
            <a id="see" href="#ssss">🐍</a>
        </section>
    </div>
</footer>

            </body>
</html>
