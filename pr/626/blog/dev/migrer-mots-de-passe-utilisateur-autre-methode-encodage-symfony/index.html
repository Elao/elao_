<!DOCTYPE html>
<html lang="fr" class="no-js">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Migrer les mots de passe utilisateur vers une autre méthode d&#039;encodage avec Symfony</title>

        <!-- Favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="/elao_/pr/626/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/elao_/pr/626/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/elao_/pr/626/favicon-16x16.png">
        <link rel="manifest" href="/elao_/pr/626/site.webmanifest">
        <link rel="mask-icon" href="/elao_/pr/626/safari-pinned-tab.svg" color="#ff4344">
        <link rel="shortcut icon" href="/elao_/pr/626/favicon.ico">
        <meta name="msapplication-TileColor" content="#ff4344">
        <meta name="msapplication-config" content="/elao_/pr/626/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">

                    <meta name="description" content="Migration continue de mots de passe legacy d&#039;une méthode d&#039;encodage à une autre dans Symfony. Par exemple, migrer de md5 vers bcrypt." />
            <link rel="canonical" href="https://elao.github.io/elao_/pr/626/blog/dev/migrer-mots-de-passe-utilisateur-autre-methode-encodage-symfony" />

            <!-- Open Graph / Facebook -->
            <meta property="og:title" content="Migrer les mots de passe utilisateur vers une autre méthode d&#039;encodage avec Symfony" />
            <meta property="og:locale" content="fr" />
            <meta property="og:description" content="Migration continue de mots de passe legacy d&#039;une méthode d&#039;encodage à une autre dans Symfony. Par exemple, migrer de md5 vers bcrypt." />
            <meta property="og:url" content="https://elao.github.io/elao_/pr/626/blog/dev/migrer-mots-de-passe-utilisateur-autre-methode-encodage-symfony" />
            <meta property="og:site_name" content="elao_" />

                                        <meta property="og:image" content="https://elao.github.io/elao_/pr/626/%2E%2E/../resized/content/images/blog/thumbnails/password.jpg/f3993c3fa5fc7aaa1016d310d3e85312.jpg">
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary_large_image">
            <meta property="twitter:title" content="Migrer les mots de passe utilisateur vers une autre méthode d&#039;encodage avec Symfony">
            <meta property="twitter:description" content="Migration continue de mots de passe legacy d&#039;une méthode d&#039;encodage à une autre dans Symfony. Par exemple, migrer de md5 vers bcrypt.">
            <meta property="twitter:site" content="@elao">
            <meta property="twitter:creator" content="@elao">
                                        <meta property="twitter:image" content="https://elao.github.io/elao_/pr/626/%2E%2E/../resized/content/images/blog/thumbnails/password.jpg/a3c0b78a6daa31b5bbf9a6b5b1890ba4.jpg">
                            <link rel="alternate" type="application/rss+xml" href="/elao_/pr/626/blog/rss.xml" title="Le blog de l'équipe d'Elao" />
        
                <script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "Migrer les mots de passe utilisateur vers une autre méthode d'encodage avec Symfony",
    "image": [
        "https://elao.github.io/elao_/pr/626/blog/dev/content/images/blog/thumbnails/password.jpg"
    ],
    "datePublished": "2017-09-12T00:00:00+00:00",
    "dateModified": "2021-06-18T00:00:00+00:00",
    "author": [
        {
            "@type": "Person",
            "name": "Maxime Colin",
            "url": "https://elao.github.io/elao_/pr/626/equipe/mcolin"
        }
    ],
    "keywords": [
        "Securite",
        "Migration",
        "Encodage",
        "Symfony"
    ]
}
    </script>
    
                            <meta name="robots" content="noindex" />
        
        <script>
                        document.querySelector('html').classList.remove('no-js');
        </script>

                    <link rel="stylesheet" href="/elao_/pr/626/build/app.c1b09c2c.css">
        
                        <script src="/elao_/pr/626/build/runtime.995fe021.js" defer></script><script src="/elao_/pr/626/build/552.3082ae9c.js" defer></script><script src="/elao_/pr/626/build/769.7dfbbe52.js" defer></script><script src="/elao_/pr/626/build/app.d906f729.js" defer></script>

                    

    <script src="https://platform.twitter.com/widgets.js"></script>
    <script async defer src="//platform.instagram.com/en_US/embeds.js"></script>

    <script>
        window.onload = (function(){
            var tweets = document.querySelectorAll('.tweet-container');
            tweets.forEach(function(tweet) {
                // https://developer.twitter.com/en/docs/twitter-for-websites/embedded-tweets/guides/embedded-tweet-parameter-reference
                twttr.widgets.createTweet(tweet.getAttribute('data-tweet-id'), tweet, {
                    conversation: 'none',
                    cards: 'hidden',
                    theme: 'light',
                    lang: 'fr',
                    align: 'center',
                    width: 550, // default
                    dnt: true,
                })
            })
        });
    </script>

        <!-- S.E.E. -->
        <meta name="see" content="&#x5B;&quot;&#x5C;&#x2F;elao_&#x5C;&#x2F;pr&#x5C;&#x2F;626&#x5C;&#x2F;build&#x5C;&#x2F;see.ace7bf9f.js&quot;&#x5D;">
        <meta name="see_style" content="&#x5B;&quot;&#x5C;&#x2F;elao_&#x5C;&#x2F;pr&#x5C;&#x2F;626&#x5C;&#x2F;build&#x5C;&#x2F;see.d77e78f8.css&quot;&#x5D;">
    </head>
    <body
        data-controller="swup-plugins symfony--ux-swup--swup swup-matomo" data-symfony--ux-swup--swup-containers-value="&#x5B;&quot;&#x23;main&quot;,&quot;&#x23;nav&quot;&#x5D;" data-symfony--ux-swup--swup-cache-value="true" data-symfony--ux-swup--swup-animate-history-browsing-value="true" data-symfony--ux-swup--swup-debug-value="false" data-symfony--ux-swup--swup-link-selector-value="a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;626&quot;&#x5D;&#x3A;not&#x28;&#x5B;data-no-swup&#x5D;&#x29;&#x3A;not&#x28;&#x5B;target&#x3D;&quot;_blank&quot;&#x5D;&#x29;&#x3A;not&#x28;a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;626&#x2F;_profiler&quot;&#x5D;&#x29;,a&#x5B;href&#x5E;&#x3D;&quot;&#x2F;&quot;&#x5D;&#x3A;not&#x28;&#x5B;data-no-swup&#x5D;&#x29;&#x3A;not&#x28;&#x5B;target&#x3D;&quot;_blank&quot;&#x5D;&#x29;&#x3A;not&#x28;a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;626&#x2F;_profiler&quot;&#x5D;&#x29;" data-swup-matomo-enabled-value="false">
                    <header id="nav" class="header">
                <div class="container">
                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/pr/626/">
                        <span class="screen-reader">Migrer les mots de passe utilisateur vers une autre méthode d&#039;encodage avec Symfony</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>

                                            <!-- Desktop nav -->
                        <nav class="nav">
                            <ul>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/626/nos-services/">
                                                                                        <span>Services</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/626/demarche">
                                                                                        <span>Démarche</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/626/etudes-de-cas">
                                                                                        <span>Études de cas</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/626/nos-valeurs">
                                                                                        <span>Valeurs</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/626/equipe">
                                                                                        <span>L&#039;équipe</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item nav__item--active">
                                        <a href="/elao_/pr/626/blog">
                                                                                        <span>Blog</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/626/contact">
                                                                                            <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                        <span>Contact</span>
                                        </a>
                                    </li>
                                                            </ul>
                        </nav>
                    
                                            <!-- Mobile nav -->
                        <nav class="nav-mobile" data-controller="toggle">
                            <div class="nav-mobile__header">
                                <a href="/elao_/pr/626/">
                                                                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                                </a>
                                <button class="nav-toggle nav-toggle--close">
                                    <i class="icon icon--close" aria-hidden="true"></i>
                                    <span class="screen-reader">Fermer le menu</span>
                                </button>
                            </div>
                            <ul>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/626/nos-services/">
                                                                                        <span>Services</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/626/demarche">
                                                                                        <span>Démarche</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/626/etudes-de-cas">
                                                                                        <span>Études de cas</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/626/nos-valeurs">
                                                                                        <span>Valeurs</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/626/equipe">
                                                                                        <span>L&#039;équipe</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item nav-mobile__item--active ">
                                        <a href="/elao_/pr/626/blog">
                                                                                        <span>Blog</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  nav-mobile__item--large">
                                        <a href="/elao_/pr/626/contact">
                                                                                            <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                        <span>Contact</span>
                                        </a>
                                    </li>
                                                            </ul>
                        </nav>
                        <button class="nav-toggle nav-toggle--open">
                            <i class="icon icon--hamburger" aria-hidden="true"></i>
                            <span class="screen-reader">Ouvrir le menu</span>
                        </button>
                                    </div>
            </header>
                <main id="main">
                <div class="container">
                                <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
            <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/626/">
                <span itemprop="name">Accueil</span>
            </a>
            <meta itemprop="position" content="1" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/626/blog">
                <span itemprop="name">Blog</span>
            </a>
            <meta itemprop="position" content="2" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/626/blog/dev">
                <span itemprop="name">Dev</span>
            </a>
            <meta itemprop="position" content="3" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="#">
                <span itemprop="name">Migrer les mots de passe utilisateur vers une autre méthode d&#039;encodage avec Symfony</span>
            </a>
            <meta itemprop="position" content="4" />
        </li></ol>

        
        <div class="article-banner">
            <div
                class="article-banner__cover"
                style="background: #f1f1f1 url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/6c6084772600659ead25e68a2cbd1d74.jpg');
    background: #f1f1f1 -webkit-image-set(
        url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/6c6084772600659ead25e68a2cbd1d74.jpg') 1x,
        url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/ea7fc065254b53418196c5751627fe2f.jpg') 2x
    );
    background: #f1f1f1 -moz-image-set(
        url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/6c6084772600659ead25e68a2cbd1d74.jpg') 1x,
        url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/ea7fc065254b53418196c5751627fe2f.jpg') 2x
    );
    background: #f1f1f1 -ms-image-set(
        url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/6c6084772600659ead25e68a2cbd1d74.jpg') 1x,
        url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/ea7fc065254b53418196c5751627fe2f.jpg') 2x
    );
    background: #f1f1f1 image-set(
        url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/6c6084772600659ead25e68a2cbd1d74.jpg') 1x,
        url('/elao_/pr/626/%2E%2E/../resized/content/images/blog/headers/password.jpg/ea7fc065254b53418196c5751627fe2f.jpg') 2x
    );"
                data-aos="fade-down"
            ></div>

            <div class="article-info" data-aos="zoom-in">
                                                    <div class="article-author ">
                        <div class="article-author__image">
                                                            <a href="/elao_/pr/626/blog/auteur/mcolin">
                                    <img     src="/elao_/pr/626/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg"
    srcset="
        /elao_/pr/626/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg 1x,
        /elao_/pr/626/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/0899bdf7169af336de983de73d88fa58.jpg 2x
    "
 />
                                </a>
                                                    </div>
                        <span class="article-author__info">
                            Écrit par
                                                            <a href="/elao_/pr/626/blog/auteur/mcolin">
                                    <strong>Maxime Colin</strong>
                                </a>
                                                    </span>
                    </div>
                                <div class="article-info__date">
                    <span>Publication <strong>12 septembre 2017</strong></span>
                                                                <span>Modification <strong>18 juin 2021</strong></span>
                                    </div>
            </div>

            <div class="article-header" data-aos="zoom-in-up">
                <h1>Migrer les mots de passe utilisateur vers une autre méthode d&#039;encodage avec Symfony</h1>
                <p>Migration continue de mots de passe legacy d&#039;une méthode d&#039;encodage à une autre dans Symfony. Par exemple, migrer de md5 vers bcrypt.</p>
                <ul class="article-tag-list">
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/626/blog/tag/securite" rel="nofollow">#Securite</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/626/blog/tag/migration" rel="nofollow">#Migration</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/626/blog/tag/encodage" rel="nofollow">#Encodage</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/626/blog/tag/symfony" rel="nofollow">#Symfony</a>
                        </li>
                                    </ul>
            </div>
        </div>

        
        <div class="article-content">
            <main class="article-content__main">

                                    <div class="alert alert--info">
                        <i class="icon icon--info" aria-hidden="true"></i>
                        <div>
                                                            <p>Cet article date un peu et il est maintenant possible de gérer la migration des mots de passe de vos utilisateurs de façon un peu plus native dans Symfony en utilisant le mécanisme de migration de <a href="https://symfony.com/doc/current/security/password_migration.html">hash de passwords</a><br /></p>
                                                    </div>
                    </div>
                
                
                <h1 id="contexte" class="anchor-title"><a href="#contexte">Contexte</a></h1>
<p>Si vous avez un jour travaillé sur la refonte d'une application, vous avez sûrement dû importer des données dites "legacy" provenant de l'application existante. Ces données contiennent bien souvent des comptes utilisateurs et donc des hashs de mots de passe qu'il faudra réintégrer à la nouvelle application.</p>
<p>Les standards de sécurité évoluent, là où hier on se contentait d'un hash md5 ou sha1, on utilise plutôt bcrypt aujoud'hui. Afin de maintenir votre application aux standards actuels, vous allez devoir migrer ces hashs de mots de passe.</p>
<h1 id="solution" class="anchor-title"><a href="#solution">Solution</a></h1>
<p>Par définition, il n'est pas possible de retrouver simplement le mot de passe à partir du hash. Vous ne pouvez donc pas simplement migrer l'ensemble de mots de passe au moment d'importer les données dans le nouveau système. La seule personne à connaitre le mot de passe en clair est l'utilisateur lui-même.</p>
<p>L'idée est donc de réaliser une migration continue lorsque l'utilisateur rentre son mot de passe.</p>
<p>Par exemple, pour une migration de mots de passe de <code class="code-inline" id="1bc29b36f623ba82aaf6724fd3b16718">md5</code> vers <code class="code-inline" id="51f01b313d48b72f46376150e6e12a98">bcrypt</code>, lors d'une tentative de connexion :</p>
<ul>
<li>Si l'utilisateur n'a pas été migré, on vérifie que le mot de passe fourni correspond au hash <code class="code-inline" id="1bc29b36f623ba82aaf6724fd3b16718">md5</code>. Si c'est le cas, on calcule le hash <code class="code-inline" id="51f01b313d48b72f46376150e6e12a98">bcrypt</code> à partir du mot de passe, puis on le stocke.</li>
<li>Si l'utilisateur a déjà été migré, on vérifie le mot de passe avec le hash <code class="code-inline" id="51f01b313d48b72f46376150e6e12a98">bcrypt</code></li>
</ul>
<p>Ainsi, chaque utilisateur migrera son mot de passe lors de sa première connexion à la nouvelle plateforme. Une fois que tous les utilisateurs auront été migrés, nous pourront effacer complètement les hashs <code class="code-inline" id="1bc29b36f623ba82aaf6724fd3b16718">md5</code> de la base de données et n'utiliser que <code class="code-inline" id="51f01b313d48b72f46376150e6e12a98">bcrypt</code>.</p>
<figure>
    <img src="/elao_/pr/626/%2E%2E/../resized/content/images/blog/2017/password-encoding-switch.png/255180c07e0a1ced0708f48057eead84.png" style="max-width: 600px;" alt="Logique de migration" srcset="/elao_/pr/626/%2E%2E/../resized/content/images/blog/2017/password-encoding-switch.png/255180c07e0a1ced0708f48057eead84.png 1x,
/elao_/pr/626/%2E%2E/../resized/content/images/blog/2017/password-encoding-switch.png/8e20d99704eff554ba1fd3a6a8160fd4.png 2x," id="logique-de-migration">
    <figcaption>Processus d'authentification</figcaption>
</figure>
<h1 id="symfony" class="anchor-title"><a href="#symfony">Symfony</a></h1>
<p>Il est possible de réaliser une méthode d'authentification intégrant ce processus de migration dans Symfony. Pour cela vous devez implémenter une authentification personnalisée. Plusieurs solutions s'offrent à vous, de la plus complexe à la plus simple:</p>
<ul>
<li><a href="http://symfony.com/doc/current/security/custom_authentication_provider.html" target="_blank">Créer un Authentication Provider</a></li>
<li><a href="http://symfony.com/doc/current/security/guard_authentication.html" target="_blank">Créer un système d'authentification avec Guard</a></li>
<li><a href="http://symfony.com/doc/current/security/custom_password_authenticator.html" target="_blank">Créer un Form Password Authenticator</a></li>
</ul>
<p>Si vous utilisez un formulaire de connexion simple, de type login/password avec l'option <code class="code-inline" id="d1ade55e74c014e97429b1988fe9c588">form_login</code>, la dernière solution est la plus simple. A la place d'utiliser <code class="code-inline" id="d1ade55e74c014e97429b1988fe9c588">form_login</code>, nous allons utiliser <code class="code-inline" id="fa938cd32723583e40742a3866827dda">simple_form</code> qui fonctionne de la même façon hormis qu'il faudra lui fournir un service dédié à l'authentification grâce à la clé <code class="code-inline" id="725d91977f189d4930c6344b016d55de">authenticator</code>.</p>
<p>Ce service doit implémenter la classe <a href="http://api.symfony.com/3.0/Symfony/Component/Security/Http/Authentication/SimpleFormAuthenticatorInterface.html" target="_blank"><code class="code-inline" id="2c937bd6d72e38e576d0f3b8575847d5">SimpleFormAuthenticatorInterface</code></a> qui requiert l'implémentation des trois méthodes suivantes :</p>
<ul>
<li><code class="code-inline" id="edf827e5ac5466e8c7d089f4bb5cecbd">createToken</code> : le formulaire est de type login/password, nous allons donc créer un <code class="code-inline" id="88837a3a69e4d25b836efde4aa299edb">UsernamePasswordToken</code>.</li>
<li><code class="code-inline" id="a2da5aafcb240a5b452c50d8963bb1c8">supportsToken</code> : l'authenticator supportera les <code class="code-inline" id="88837a3a69e4d25b836efde4aa299edb">UsernamePasswordToken</code>.</li>
<li><code class="code-inline" id="1977adc8e5b3a2698814d9e0f3bdf1ef">authenticateToken</code> : et enfin, c'est ici que nous allons mettre notre logique d'authentification.</li>
</ul>
<p>Dans l'exemple suivant, la méthode d'encodage "legacy" est la suivante : <code class="code-inline" id="04c309e39673cc293610030f3837ce76">HASH = MD5(PASSWORD + SALT)</code>. Si l'application à refondre est déjà une application Symfony utilisant un encodeur de Symfony, vous pouvez le reproduire dans votre refonte et l'injecter dans votre service.</p>
<pre class="code-multiline language-php"><code class="language-php" id="4b8c551b3ef4414362029e06777dfb58"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Infrastructure</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">MigrationAuthenticator</span> <span class="token keyword">implements</span> <span class="token class-name">SimpleFormAuthenticatorInterface</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$encoder</span><span class="token punctuation">,</span> <span class="token variable">$em</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">UserPasswordEncoderInterface</span> <span class="token variable">$encoder</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">EntityManager</span> <span class="token variable">$em</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">encoder</span> <span class="token operator">=</span> <span class="token variable">$encoder</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">em</span>      <span class="token operator">=</span> <span class="token variable">$em</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">authenticateToken</span><span class="token punctuation">(</span><span class="token class-name type-declaration">TokenInterface</span> <span class="token variable">$token</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">UserProviderInterface</span> <span class="token variable">$userProvider</span><span class="token punctuation">,</span> <span class="token variable">$providerKey</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$userProvider</span><span class="token operator">-&gt;</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token operator">-&gt;</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$token</span><span class="token operator">-&gt;</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// The user hasn't password, it's not migrated</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">null</span> <span class="token operator">===</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Check legacy password with legacy encoding method</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token operator">.</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getLegacySalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getLegacyPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// Encode the password and migrate the user</span>
                <span class="token variable">$encodedPassword</span> <span class="token operator">=</span> <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">encoder</span><span class="token operator">-&gt;</span><span class="token function">encodePassword</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">updatePassword</span><span class="token punctuation">(</span><span class="token variable">$encodedPassword</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">em</span><span class="token operator">-&gt;</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span>
                    <span class="token variable">$user</span><span class="token punctuation">,</span>
                    <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token variable">$providerKey</span><span class="token punctuation">,</span>
                    <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Check password with the current encoder</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">encoder</span><span class="token operator">-&gt;</span><span class="token function">isPasswordValid</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span>
                    <span class="token variable">$user</span><span class="token punctuation">,</span>
                    <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token variable">$providerKey</span><span class="token punctuation">,</span>
                    <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid username or password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">supportsToken</span><span class="token punctuation">(</span><span class="token class-name type-declaration">TokenInterface</span> <span class="token variable">$token</span><span class="token punctuation">,</span> <span class="token variable">$providerKey</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$token</span> <span class="token keyword">instanceof</span> <span class="token class-name">UsernamePasswordToken</span>
            <span class="token operator">&amp;&amp;</span> <span class="token variable">$token</span><span class="token operator">-&gt;</span><span class="token function">getProviderKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token variable">$providerKey</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createToken</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">,</span> <span class="token variable">$providerKey</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">,</span> <span class="token variable">$providerKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>Déclarez votre service :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="2ada8155fd219d6ebc8db9ca97ea47d1"><span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.migration_authenticator</span><span class="token punctuation">:</span>
        <span class="token key atrule">class</span><span class="token punctuation">:</span> App\Infrastructure\MigrationAuthenticator
        <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">'@security.user_password_encoder.generic'</span>
            <span class="token punctuation">-</span> <span class="token string">'@doctrine.orm.entity_manager'</span></code></pre>
<p>Puis renseignez le dans la configuration de votre firewall :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="c006485b5606891034e8f03904310a05"><span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">encoders</span><span class="token punctuation">:</span>
        <span class="token key atrule">App\Domain\Model\User</span><span class="token punctuation">:</span>
            <span class="token key atrule">algorithm</span><span class="token punctuation">:</span> bcrypt
            <span class="token key atrule">cost</span><span class="token punctuation">:</span>      <span class="token number">12</span>
    <span class="token key atrule">firewalls</span><span class="token punctuation">:</span>
        <span class="token key atrule">main</span><span class="token punctuation">:</span>
            <span class="token key atrule">pattern</span><span class="token punctuation">:</span> ^/
            <span class="token key atrule">anonymous</span><span class="token punctuation">:</span> <span class="token null important">~</span>
            <span class="token key atrule">simple_form</span><span class="token punctuation">:</span>
                <span class="token key atrule">authenticator</span><span class="token punctuation">:</span> app.migration_authenticator
                <span class="token key atrule">login_path</span><span class="token punctuation">:</span> login
                <span class="token key atrule">check_path</span><span class="token punctuation">:</span> login_check</code></pre>
<p>Si vous avez besoin de créer un <code class="code-inline" id="08ce529718c22bc07eb6e053ca3d0704">Authentication Provider</code> ou d'utiliser le composant <code class="code-inline" id="57cc9b210b0e3ff7b28013cec3d36acf">Guard</code>, reportez vous à la documentation de Symfony pour savoir où integrer le processus d'authentification, mais le principe reste le même.</p>
<h1 id="bonus" class="anchor-title"><a href="#bonus">Bonus</a></h1>
<p>En bonus, après un certain temps, vous pourrez identifier les utilisateurs qui ne sont plus actifs, ils correspondront aux utilisateurs qui n'auront pas migré leur mot de passe.</p>
                                                                </main>
            <aside class="article-content__aside">
                            </aside>
        </div>

        <div class="article-footer" data-aos="fade-in">
                                                <div class="article-author">
                        <div class="article-author__image">
                            <a href="/elao_/pr/626/blog/auteur/mcolin">
                                <img     src="/elao_/pr/626/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg"
    srcset="
        /elao_/pr/626/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg 1x,
        /elao_/pr/626/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/0899bdf7169af336de983de73d88fa58.jpg 2x
    "
 />
                            </a>
                        </div>
                        <span class="article-author__info">
                            Écrit par
                            <a href="/elao_/pr/626/blog/auteur/mcolin">
                                <strong>Maxime Colin</strong>
                            </a>
                        </span>

                        <div class="article-author__social">
                                                            <a href="https://twitter.com/colin_maxime" class="social social--small">
                                    <i class="icon icon--x" aria-hidden="true"></i>
                                    <span class="screen-reader">Compte Twitter de Maxime Colin</span>
                                </a>
                                                                                        <a href="https://github.com/maximecolin " class="social social--small">
                                    <i class="icon icon--github" aria-hidden="true"></i>
                                    <span class="screen-reader">Compte github de Maxime Colin</span>
                                </a>
                                                                                        <a href="https://www.maximecolin.fr/" class="social social--small">
                                    <i class="icon icon--website" aria-hidden="true"></i>
                                    <span class="screen-reader">Site personnel de Maxime Colin</span>
                                </a>
                                                    </div>
                    </div>
                                    </div>

                <div class="bricks">
            
                            <div class="brick-contribute">
                    <p>
                        Une typo ?
                        <a href="https://github.com/Elao/elao_/edit/blog/workflow-git-fixes/content/blog/dev/migrer-mots-de-passe-utilisateur-autre-methode-encodage-symfony.md/" target="_blank" class="animated-link animated-link--light">
                            Modifier cet article sur Github
                        </a>
                    </p>
                </div>
                    </div>
            </div>
        </main>
                    
<footer class="footer">
    <div class="container">
        <section class="footer__links">
            <p class="h1">
                elao
                <span>développe</span>
                <span>du lien</span>
            </p>
            <div class="links">
                                    <ul>
                                                    <li>
                                <a href="/elao_/pr/626/nos-services/" >Services</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/626/demarche" >Démarche</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/626/etudes-de-cas" >Études de cas</a>
                            </li>
                                            </ul>
                                    <ul>
                                                    <li>
                                <a href="/elao_/pr/626/nos-valeurs" >Valeurs</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/626/equipe" >L&#039;équipe</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/626/blog" >Blog</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/626/blog/rss.xml"  data-no-swup="data-no-swup">RSS</a>
                            </li>
                                            </ul>
                                <ul>
                    <li>
                                                <a href="/elao_/pr/626/recrutement">
                            Nous recrutons
                                                            <span class="bullet">2</span>
                                                    </a>
                    </li>
                    <li>
                        <a href="/elao_/pr/626/glossaire/">Glossaire 🧐</a>
                    </li>
                    <li>
                        <a href="/elao_/pr/626/elaomojis">Elaomojis 🎉</a>
                    </li>
                </ul>
            </div>
            <div class="socials">
                <ul>
                    <li>
                        <a href="https://github.com/elao" target="_blank">
                            <i class="icon icon--github"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/elao" target="_blank">
                            <i class="icon icon--x"></i>
                            Twitter
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/company/elao/mycompany/" target="_blank">
                            <i class="icon icon--linkedin"></i>
                            Linkedin
                        </a>
                    </li>
                </ul>
            </div>
            <div class="contacts">
                <ul>
                    <li>
                        <a href="/elao_/pr/626/contact">Contact</a>
                    </li>
                    <li>
                        <a href="tel:04 82 53 37 19">04 82 53 37 19</a>
                    </li>
                    <li>
                        <a href="mailto:contact@elao.com">contact@elao.com</a>
                    </li>
                    <li>34 rue Jean Broquin</li>
                    <li>69006 Lyon</li>
                </ul>
            </div>
        </section>

        <section class="footer__legals">
            <span>© 2005 - 2024 - ELAO - Tous droits réservés</span>
            <a href="/elao_/pr/626/legal">Mentions légales</a>
            <a href="/elao_/pr/626/confidentialite">Protection des données</a>
            <a id="see" href="#ssss">🐍</a>
        </section>
    </div>
</footer>

            </body>
</html>
