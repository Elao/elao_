<!DOCTYPE html>
<html lang="fr" class="no-js">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Écrire des tests Behat proches de son domaine</title>

        <!-- Favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="/elao_/pr/651/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/elao_/pr/651/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/elao_/pr/651/favicon-16x16.png">
        <link rel="manifest" href="/elao_/pr/651/site.webmanifest">
        <link rel="mask-icon" href="/elao_/pr/651/safari-pinned-tab.svg" color="#ff4344">
        <link rel="shortcut icon" href="/elao_/pr/651/favicon.ico">
        <meta name="msapplication-TileColor" content="#ff4344">
        <meta name="msapplication-config" content="/elao_/pr/651/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">

                    <meta name="description" content="" />
            <link rel="canonical" href="https://elao.github.io/elao_/pr/651/blog/dev/ecrire-des-tests-behat-proches-de-son-domaine" />

            <!-- Open Graph / Facebook -->
            <meta property="og:title" content="Écrire des tests Behat proches de son domaine" />
            <meta property="og:locale" content="fr" />
            <meta property="og:description" content="" />
            <meta property="og:url" content="https://elao.github.io/elao_/pr/651/blog/dev/ecrire-des-tests-behat-proches-de-son-domaine" />
            <meta property="og:site_name" content="elao_" />

                                        <meta property="og:image" content="https://elao.github.io/elao_/pr/651/%2E%2E/../resized/content/images/blog/thumbnails/ecrire-des-tests-behat-proche-de-son-domaine-thumbnail.png/cfe2265def849b44b9d8a6a610082321.png">
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary_large_image">
            <meta property="twitter:title" content="Écrire des tests Behat proches de son domaine">
            <meta property="twitter:description" content="">
            <meta property="twitter:site" content="@elao">
            <meta property="twitter:creator" content="@elao">
                                        <meta property="twitter:image" content="https://elao.github.io/elao_/pr/651/%2E%2E/../resized/content/images/blog/thumbnails/ecrire-des-tests-behat-proche-de-son-domaine-thumbnail.png/f8017b71f2788c2c60de178822ff76d2.png">
                            <link rel="alternate" type="application/rss+xml" href="/elao_/pr/651/blog/rss.xml" title="Le blog de l'équipe d'Elao" />
        
                <script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "Écrire des tests Behat proches de son domaine",
    "image": [
        "https://elao.github.io/elao_/pr/651/blog/dev/content/images/blog/thumbnails/ecrire-des-tests-behat-proche-de-son-domaine-thumbnail.png"
    ],
    "datePublished": "2018-06-17T00:00:00+00:00",
    "dateModified": "2018-06-17T00:00:00+00:00",
    "author": [
        {
            "@type": "Person",
            "name": "Nicolas Dievart",
            "url": "https://elao.github.io/elao_/pr/651/equipe"
        }
    ],
    "keywords": [
        "Behat",
        "Symfony",
        "Ddd"
    ]
}
    </script>
    
                            <meta name="robots" content="noindex" />
        
        <script>
                        document.querySelector('html').classList.remove('no-js');
        </script>

                    <link rel="stylesheet" href="/elao_/pr/651/build/app.2c52d116.css">
        
                        <script src="/elao_/pr/651/build/runtime.4f991585.js" defer></script><script src="/elao_/pr/651/build/552.3082ae9c.js" defer></script><script src="/elao_/pr/651/build/769.7dfbbe52.js" defer></script><script src="/elao_/pr/651/build/app.d906f729.js" defer></script>

                    

    <script src="https://platform.twitter.com/widgets.js"></script>
    <script async defer src="//platform.instagram.com/en_US/embeds.js"></script>

    <script>
        window.onload = (function(){
            var tweets = document.querySelectorAll('.tweet-container');
            tweets.forEach(function(tweet) {
                // https://developer.twitter.com/en/docs/twitter-for-websites/embedded-tweets/guides/embedded-tweet-parameter-reference
                twttr.widgets.createTweet(tweet.getAttribute('data-tweet-id'), tweet, {
                    conversation: 'none',
                    cards: 'hidden',
                    theme: 'light',
                    lang: 'fr',
                    align: 'center',
                    width: 550, // default
                    dnt: true,
                })
            })
        });
    </script>

        <!-- S.E.E. -->
        <meta name="see" content="&#x5B;&quot;&#x5C;&#x2F;elao_&#x5C;&#x2F;pr&#x5C;&#x2F;651&#x5C;&#x2F;build&#x5C;&#x2F;see.ace7bf9f.js&quot;&#x5D;">
        <meta name="see_style" content="&#x5B;&quot;&#x5C;&#x2F;elao_&#x5C;&#x2F;pr&#x5C;&#x2F;651&#x5C;&#x2F;build&#x5C;&#x2F;see.d77e78f8.css&quot;&#x5D;">
    </head>
    <body
        data-controller="swup-plugins symfony--ux-swup--swup swup-matomo" data-symfony--ux-swup--swup-containers-value="&#x5B;&quot;&#x23;main&quot;,&quot;&#x23;nav&quot;&#x5D;" data-symfony--ux-swup--swup-cache-value="true" data-symfony--ux-swup--swup-animate-history-browsing-value="true" data-symfony--ux-swup--swup-debug-value="false" data-symfony--ux-swup--swup-link-selector-value="a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;651&quot;&#x5D;&#x3A;not&#x28;&#x5B;data-no-swup&#x5D;&#x29;&#x3A;not&#x28;&#x5B;target&#x3D;&quot;_blank&quot;&#x5D;&#x29;&#x3A;not&#x28;a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;651&#x2F;_profiler&quot;&#x5D;&#x29;,a&#x5B;href&#x5E;&#x3D;&quot;&#x2F;&quot;&#x5D;&#x3A;not&#x28;&#x5B;data-no-swup&#x5D;&#x29;&#x3A;not&#x28;&#x5B;target&#x3D;&quot;_blank&quot;&#x5D;&#x29;&#x3A;not&#x28;a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;651&#x2F;_profiler&quot;&#x5D;&#x29;" data-swup-matomo-enabled-value="false">
                    <header id="nav" class="header">
                <div class="container">
                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/pr/651/">
                        <span class="screen-reader">Écrire des tests Behat proches de son domaine</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>

                                            <!-- Desktop nav -->
                        <nav class="nav">
                            <ul>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/651/nos-services/">
                                                                                        <span>Services</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/651/demarche">
                                                                                        <span>Démarche</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/651/etudes-de-cas">
                                                                                        <span>Études de cas</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/651/nos-valeurs">
                                                                                        <span>Valeurs</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/651/equipe">
                                                                                        <span>L&#039;équipe</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item nav__item--active">
                                        <a href="/elao_/pr/651/blog">
                                                                                        <span>Blog</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/651/contact">
                                                                                            <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                        <span>Contact</span>
                                        </a>
                                    </li>
                                                            </ul>
                        </nav>
                    
                                            <!-- Mobile nav -->
                        <nav class="nav-mobile" data-controller="toggle">
                            <div class="nav-mobile__header">
                                <a href="/elao_/pr/651/">
                                                                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                                </a>
                                <button class="nav-toggle nav-toggle--close">
                                    <i class="icon icon--close" aria-hidden="true"></i>
                                    <span class="screen-reader">Fermer le menu</span>
                                </button>
                            </div>
                            <ul>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/651/nos-services/">
                                                                                        <span>Services</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/651/demarche">
                                                                                        <span>Démarche</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/651/etudes-de-cas">
                                                                                        <span>Études de cas</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/651/nos-valeurs">
                                                                                        <span>Valeurs</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/651/equipe">
                                                                                        <span>L&#039;équipe</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item nav-mobile__item--active ">
                                        <a href="/elao_/pr/651/blog">
                                                                                        <span>Blog</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  nav-mobile__item--large">
                                        <a href="/elao_/pr/651/contact">
                                                                                            <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                        <span>Contact</span>
                                        </a>
                                    </li>
                                                            </ul>
                        </nav>
                        <button class="nav-toggle nav-toggle--open">
                            <i class="icon icon--hamburger" aria-hidden="true"></i>
                            <span class="screen-reader">Ouvrir le menu</span>
                        </button>
                                    </div>
            </header>
                <main id="main">
                <div class="container">
                                <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
            <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/651/">
                <span itemprop="name">Accueil</span>
            </a>
            <meta itemprop="position" content="1" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/651/blog">
                <span itemprop="name">Blog</span>
            </a>
            <meta itemprop="position" content="2" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/651/blog/dev">
                <span itemprop="name">Dev</span>
            </a>
            <meta itemprop="position" content="3" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="#">
                <span itemprop="name">Écrire des tests Behat proches de son domaine</span>
            </a>
            <meta itemprop="position" content="4" />
        </li></ol>

        
        <div class="article-banner">
            <div
                class="article-banner__cover"
                style="background: #f1f1f1 url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/fbc80f630bd95b50ded8c5c50404d20b.jpg');
    background: #f1f1f1 -webkit-image-set(
        url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/fbc80f630bd95b50ded8c5c50404d20b.jpg') 1x,
        url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/345c6be4df887a41d11d363e3e1db8ef.jpg') 2x
    );
    background: #f1f1f1 -moz-image-set(
        url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/fbc80f630bd95b50ded8c5c50404d20b.jpg') 1x,
        url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/345c6be4df887a41d11d363e3e1db8ef.jpg') 2x
    );
    background: #f1f1f1 -ms-image-set(
        url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/fbc80f630bd95b50ded8c5c50404d20b.jpg') 1x,
        url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/345c6be4df887a41d11d363e3e1db8ef.jpg') 2x
    );
    background: #f1f1f1 image-set(
        url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/fbc80f630bd95b50ded8c5c50404d20b.jpg') 1x,
        url('/elao_/pr/651/%2E%2E/../resized/content/images/blog/headers/ecrire-test-behat-proche-de-son-domaine.jpg/345c6be4df887a41d11d363e3e1db8ef.jpg') 2x
    );"
                data-aos="fade-down"
            ></div>

            <div class="article-info" data-aos="zoom-in">
                                                    <div class="article-author ">
                        <div class="article-author__image">
                                                            <a>
                                    <img     src="/elao_/pr/651/%2E%2E/../resized/content/images/members/avatars/ndievart.jpg/a74abe0a7281efd3b7446bf221cbb4f9.jpg"
    srcset="
        /elao_/pr/651/%2E%2E/../resized/content/images/members/avatars/ndievart.jpg/a74abe0a7281efd3b7446bf221cbb4f9.jpg 1x,
        /elao_/pr/651/%2E%2E/../resized/content/images/members/avatars/ndievart.jpg/0a5b8f386b3f9ef6ffd06c5654ceca72.jpg 2x
    "
 />
                                </a>
                                                    </div>
                        <span class="article-author__info">
                            Écrit par
                                                            <a href="/elao_/pr/651/blog/auteur/ndievart">
                                    <strong>Nicolas Dievart</strong>
                                </a>
                                                    </span>
                    </div>
                                <div class="article-info__date">
                    <span>Publication <strong>17 juin 2018</strong></span>
                                                        </div>
            </div>

            <div class="article-header" data-aos="zoom-in-up">
                <h1>Écrire des tests Behat proches de son domaine</h1>
                <p></p>
                <ul class="article-tag-list">
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/651/blog/tag/behat" rel="nofollow">#Behat</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/651/blog/tag/symfony" rel="nofollow">#Symfony</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/651/blog/tag/ddd" rel="nofollow">#Ddd</a>
                        </li>
                                    </ul>
            </div>
        </div>

                    <ol class="table-of-content" data-aos="fade-up">
                                    <li class="table-of-content__item">
                        <a href="#cheminement">Cheminement 📖</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#mise-en-place">Mise en place 🔧</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#passage-d-informations-entre-step">Passage d&#039;informations entre step 📦</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#axes-d-amelioration">Axes d&#039;amélioration 🚀</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#en-conclusion">En conclusion 🎬</a>

                                            </li>
                            </ol>
        
        <div class="article-content">
            <main class="article-content__main">

                
                
                <p>Il y a quelque temps nous publiions un article sur <a href="/elao_/pr/651/blog/dev/behat-3-test-fonctionnel-symfony">l'utilisation Behat 3 pour l'écriture des tests fonctionnels Symfony</a>. Depuis les choses ont beaucoup changé sur les différents projets où nous posons du Behat pour nos tests fonctionnels.
Dans cet article nous allons voir comment nous écrivons désormais nos tests en partant d'une approche Domaine.</p>
<h2 id="cheminement" class="anchor-title"><a href="#cheminement">Cheminement 📖</a></h2>
<p>L'ajout et le maintien des tests fonctionnels se sont avérés de plus en plus complexes à réaliser sur plusieurs de nos projets avec une grande complexité métier. Certains parcours utilisateur étaient compliqués à mettre en place. Le maintien à jour des fixtures de tests devenait difficile, les dépendances entre les entités testées les rendant encore plus complexes.</p>
<p>Dans de nombreux cas, nous en arrivions à faire une fixture particulière pour chaque test plutôt que de réutiliser certaines d'entre elles pour être totalement maître du contexte. A chaque modification du <em>model</em>, la mise à jour de toutes les fixtures étaient une réelle perte de temps.</p>
<p>La plupart des projets chez Elao ont <a href="/elao_/pr/651/blog/dev/architecture-hexagonale-symfony">une architecture hexagonale</a> et sont orientés DDD, Domain Driven Design. Nous avons donc déjà toutes les méthodes métiers nécessaires pour créer des entités pour les contextes qui nous intéressent.</p>
<p>Par exemple, nous avons dans notre classe métier «Produit» des méthodes nous permettant de créer directement des produits de différent <em>types</em> comme des formules. Ces méthodes permettent d'abstraire certaines informations inutiles à faire figurer à chaque endroit du code et simplifient la création de ces produits.
Nos <em>commands</em> utilisent donc déjà ces méthodes pour créer des formules, et sont très flexibles pour chaque besoin différent.</p>
<pre class="code-multiline language-php"><code class="language-php" id="215969978c1f38f746eed6939cb5d160"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Product</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token constant">TYPE_PLAN</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'plan'</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">createPlan</span><span class="token punctuation">(</span>
      <span class="token keyword type-hint">string</span> <span class="token variable">$reference</span><span class="token punctuation">,</span>
      <span class="token keyword type-hint">int</span> <span class="token variable">$price</span><span class="token punctuation">,</span>
      <span class="token keyword type-hint">float</span> <span class="token variable">$vat</span><span class="token punctuation">,</span>
      <span class="token keyword type-hint">int</span> <span class="token variable">$stock</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">self</span><span class="token punctuation">(</span>
        <span class="token scope"><span class="token keyword">self</span><span class="token punctuation">::</span></span><span class="token constant">TYPE_PLAN</span><span class="token punctuation">,</span>
        <span class="token variable">$reference</span><span class="token punctuation">,</span>
        <span class="token variable">$price</span><span class="token punctuation">,</span>
        <span class="token variable">$vat</span><span class="token punctuation">,</span>
        <span class="token variable">$stock</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>Nous avons initié cette réflexion après avoir rencontré les problèmes cités ci-dessus, mais également en explorant le code source, et notamment les tests fonctionnels du projet <a href="https://github.com/Sylius/Sylius/tree/master/features" target="_blank">Sylius</a>.</p>
<p>Mais, arrêtons de tourner autour du pot. À quoi ressemble un test fonctionnel avec une orientation métier ?</p>
<pre class="code-multiline language-gherkin"><code class="language-gherkin" id="3ca4dbd71e78cfacc5a8a3f87f641ddd"><span class="token feature"><span class="token keyword">Feature:</span><span class="token important"> Manage the plans</span>
  As an Admin, in order to manage my plans, I need to be able to create and update the plans
</span>
  <span class="token scenario"><span class="token keyword">Scenario:</span><span class="token important"> I can update a plan</span></span>
    <span class="token atrule">Given</span> the database is purged
    <span class="token atrule">And</span> there is a plan named <span class="token string">"Premium"</span> with a price of 100
    <span class="token atrule">And</span> the super admin <span class="token string">"admin@example.net"</span> is created
    <span class="token atrule">And</span> <span class="token atrule">I</span> am logged with <span class="token string">"admin@example.net"</span>
    <span class="token atrule">When</span> <span class="token atrule">I</span> go to this page <span class="token string">"/fr/product/1/update/plan"</span>
    <span class="token atrule">Then</span> the <span class="token string">"reference"</span> field should contain <span class="token string">"Premium"</span>
    <span class="token atrule">And</span> <span class="token atrule">I</span> fill in the following:<span class="token table-head">
      <span class="token punctuation">|</span><span class="token th variable"> reference </span><span class="token punctuation">|</span><span class="token th variable"> Early bird </span><span class="token punctuation">|</span></span><span class="token table-body">
      <span class="token punctuation">|</span><span class="token td string"> price     </span><span class="token punctuation">|</span><span class="token td string"> 20         </span><span class="token punctuation">|</span></span>
    <span class="token atrule">And</span> <span class="token atrule">I</span> submit the form
    <span class="token atrule">And</span> <span class="token atrule">I</span> should be on this page <span class="token string">"/fr/product"</span>
    <span class="token atrule">And</span> the plan <span class="token string">"Early bird"</span> must cost 20</code></pre>
<p>Nous n'avons plus à <em>loader</em> des fixtures et à les maintenir, maintenant, nous pouvons utiliser un même <em>step</em> (<code class="code-inline" id="b5e16839738de26b9c311506efb87da8">And there is a plan called "AAAA" with a price of DDD</code>) pour plusieurs de nos tests fonctionnels, ce qui nous permet de créer des formules dans divers contextes.</p>
<blockquote>
<p>Comment mettre tout cela en place avec Behat ?</p>
</blockquote>
<h2 id="mise-en-place" class="anchor-title"><a href="#mise-en-place">Mise en place 🔧</a></h2>
<p>Tout d'abord, nous avons besoin d'installer Behat en <em>dev-dependencies</em> de notre composer.json</p>
<pre class="code-multiline language-json"><code class="language-json" id="f6373660aa6874baed3c403ae6ba159c"><span class="token property">"require-dev"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"behat/behat"</span><span class="token operator">:</span> <span class="token string">"^3.1"</span><span class="token punctuation">,</span>
    <span class="token property">"behat/mink-browserkit-driver"</span><span class="token operator">:</span> <span class="token string">"^1.3"</span><span class="token punctuation">,</span>
    <span class="token property">"behat/mink-extension"</span><span class="token operator">:</span> <span class="token string">"^2.2"</span><span class="token punctuation">,</span>
    <span class="token property">"behat/symfony2-extension"</span><span class="token operator">:</span> <span class="token string">"^2.1"</span><span class="token punctuation">,</span>
    <span class="token property">"webmozart/assert"</span><span class="token operator">:</span> <span class="token string">"^1.1"</span>
<span class="token punctuation">}</span></code></pre>
<p>Le point d'entrée de Behat est le fichier <code class="code-inline" id="7bde54db60a6e933518d8b61b929edce">behat.yml.dist</code> à la racine de notre projet. Afin de déporter l'ensemble de la logique de notre code Behat dans un seul et même endroit, notre fichier <code class="code-inline" id="7bde54db60a6e933518d8b61b929edce">behat.yml.dist</code> ne sert qu'à importer notre fichier de configuration:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="b9a33ad24817bb259d095b6e40be60fd"><span class="token key atrule">imports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> features/Behat/Resources/config/default.yml</code></pre>
<p>L'architecture des repertoires de nos tests fonctionnels est la suivante:</p>
<pre class="code-multiline"><code id="2a0f1f9f95cffeeea50036d41536ea92">- features/
    - Behat/ contient le code de nos proxys métier et nos contextes
    - product/ contient les tests .features sur les produits
    - user/ contient les tests .features sur les utilisateurs
    - ...
- src/ code métier</code></pre>
<p>Le point d'entrée est donc le repertoire <code class="code-inline" id="9a1a4359f87a67855aa82c0560dc9571">features/</code> dans lequel nous stockons à la fois nos tests mais aussi nos services et contextes.</p>
<p>Expliquons ensuite comment réaliser un <em>step</em> comme <code class="code-inline" id="73b4fff7735084f3eb0f3d9cdbc6d654">And there is a plan named "Premium" with a price of 100</code>.</p>
<p>Nous allons donc créer un <em>Manager</em> qui nous permettra d'appeler nos méthodes de création de produits, de modifier des paramètres, d'appeler les <em>repositories</em> pour persister en base de données ce qui doit l'être etc...</p>
<pre class="code-multiline"><code id="aaa1d04de6c84d5bf9464df58d679a7d">features/Behat/Manager/ProductManager.php</code></pre>
<pre class="code-multiline language-php"><code class="language-php" id="fe7fa3f394caf75aa456cf69c1767bcf"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Manager</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductManager</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$productRepository</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token class-name type-declaration">ProductRepositoryInterface</span> <span class="token variable">$productRepository</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productRepository</span> <span class="token operator">=</span> <span class="token variable">$productRepository</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createPlan</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$reference</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$price</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
         <span class="token variable">$plan</span> <span class="token operator">=</span> <span class="token scope">Product<span class="token punctuation">::</span></span><span class="token function">createPlan</span><span class="token punctuation">(</span>
            <span class="token variable">$reference</span><span class="token punctuation">,</span>
            <span class="token variable">$price</span><span class="token punctuation">,</span>
            <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token number">100</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productRepository</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$plan</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>Ce <em>Manager</em> utilise la méthode <em>static</em> que nous avons vue précédemment qui est également utilisée dans notre code métier. Nous aurions pu utiliser notre <em>Command Handler</em> métier qui permet de créer une formule et donc ne pas à avoir à dupliquer certaines parties de notre code, mais pour des raisons de simplifications, nous partirons sur cet exemple.</p>
<p>Nous allons ensuite créer un service qui va nous servir de <em>proxy</em>, sous la forme d'un passe-plat, pour pouvoir appeler notre <em>Manager</em> dans nos contextes Behat.</p>
<pre class="code-multiline"><code id="5d027ae4f1ef6f346d38949eb501b214">features/Behat/Proxy/ProductProxy.php</code></pre>
<pre class="code-multiline language-php"><code class="language-php" id="65631bd34a1dc239da6b4d378a2a0a45"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Proxy</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductProxy</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$productManager</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token class-name type-declaration">ProductManager</span> <span class="token variable">$productManager</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productManager</span> <span class="token operator">=</span> <span class="token variable">$productManager</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getProductManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">ProductManager</span>
    <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productManager</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>Et enfin, nous allons créer un <em>ProductContext</em> afin de créer notre <em>step</em> Gherkin</p>
<pre class="code-multiline"><code id="fc3176115fcdda706d153bd9a65a0e41">features/Behat/Context/ProductProxy.php</code></pre>
<pre class="code-multiline language-php"><code class="language-php" id="dc1733b9884ee697e6b05c8f164e2d50"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Behat<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Context<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductContext</span> <span class="token keyword">implements</span> <span class="token class-name">Context</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$productProxy</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token class-name type-declaration">ProductProxy</span> <span class="token variable">$productProxy</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productProxy</span> <span class="token operator">=</span> <span class="token variable">$productProxy</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * @Given there is a plan named :reference with a price of :price
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createPlan</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$reference</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$price</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productProxy</span>
            <span class="token operator">-&gt;</span><span class="token function">getProductManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">createPlan</span><span class="token punctuation">(</span><span class="token variable">$reference</span><span class="token punctuation">,</span> <span class="token variable">$price</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>Ensuite, nous n'avons plus qu'à modifier notre fichier <code class="code-inline" id="2bf3b3125ba5785a8776c7139dc87da1">default.yml</code> afin de lui spécifier l'utilisation du nouveau contexte que nous venons de créer.</p>
<pre class="code-multiline"><code id="bf92f44b6fa6c31bf31a75b778452a6b">features/Behat/Resources/config/default.yml</code></pre>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="a00614c37c30e64fbcdd98ece787be71"><span class="token key atrule">default</span><span class="token punctuation">:</span>
    <span class="token key atrule">extensions</span><span class="token punctuation">:</span>
        <span class="token key atrule">Behat\Symfony2Extension</span><span class="token punctuation">:</span>
            <span class="token key atrule">kernel</span><span class="token punctuation">:</span>
               <span class="token key atrule">env</span><span class="token punctuation">:</span> test
               <span class="token key atrule">bootstrap</span><span class="token punctuation">:</span> <span class="token string">'vendor/autoload.php'</span>
        <span class="token key atrule">Behat\MinkExtension</span><span class="token punctuation">:</span>
            <span class="token key atrule">base_url</span><span class="token punctuation">:</span>  <span class="token string">'http://localhost:8000/app_test.php'</span>
            <span class="token key atrule">sessions</span><span class="token punctuation">:</span>
                <span class="token key atrule">default</span><span class="token punctuation">:</span>
                    <span class="token key atrule">symfony2</span><span class="token punctuation">:</span> <span class="token null important">~</span>
    <span class="token key atrule">suites</span><span class="token punctuation">:</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
            <span class="token key atrule">contexts</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">App\Tests\Behat\Context\ProductContext</span><span class="token punctuation">:</span>
                    <span class="token punctuation">-</span> <span class="token string">'@App\Tests\Behat\Proxy\ProductProxy'</span></code></pre>
<p>Nous sommes donc maintenant en mesure d'utiliser notre <em>step</em> dans nos features Behat et de créer des formules facilement, sans utiliser de fixtures. Ce qui permet l'évolution de nos tests avec notre code métier.</p>
<p>Maintenant que nos services sont en place, nous pouvons réaliser de nouveaux <em>steps</em> qui nous permettent de tester simplement le fonctionnement de la plateforme.
Nous allons réaliser le <em>step</em> précédent <code class="code-inline" id="23cb0019afa3b691620a50ab1b64a607">And the plan "Early bird" must cost 20</code> qui nous permet de tester que notre formule a bien été modifiée au bon prix.</p>
<p>Nous modifions alors notre <em>Manager</em> afin d'y ajouter la fonction de récupération d'une formule via le <em>repository</em>. Notre <em>ProductContext</em> accède donc à la formule et peut tester que son prix a bien été modifié comme nous le souhaitons.</p>
<pre class="code-multiline language-php"><code class="language-php" id="55e1c8b5c0e14528689e15d59a1d71d6"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Manager</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductManager</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getPlanByReference</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$reference</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Product</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productRepository</span>
            <span class="token operator">-&gt;</span><span class="token function">getPlanByReference</span><span class="token punctuation">(</span><span class="token variable">$reference</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<pre class="code-multiline language-php"><code class="language-php" id="49f33b840a18139c3e8b2eff7231ea2a"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Behat<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Context<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Webmozart<span class="token punctuation">\</span>Assert<span class="token punctuation">\</span>Assert</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductContext</span> <span class="token keyword">implements</span> <span class="token class-name">Context</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ..</span>

    <span class="token doc-comment comment">/**
     * @Given the plan :reference must cost :price
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">thePlanMustCost</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$reference</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$price</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$plan</span> <span class="token operator">=</span> <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productProxy</span>
            <span class="token operator">-&gt;</span><span class="token function">getProductManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">getPlanByReference</span><span class="token punctuation">(</span><span class="token variable">$reference</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>

        <span class="token scope">Assert<span class="token punctuation">::</span></span><span class="token function">same</span><span class="token punctuation">(</span><span class="token variable">$plan</span><span class="token operator">-&gt;</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$price</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>Et c'est tout, pas besoin de <em>parser</em> le <em>DOM</em> pour retrouver la valeur du prix de la formule et vérifier si il est égale à A ou B. Cela rend les <em>steps</em> Behat beaucoup plus lisibles.</p>
<h2 id="passage-d-informations-entre-step" class="anchor-title"><a href="#passage-d-informations-entre-step">Passage d'informations entre step 📦</a></h2>
<p>Au fur et à mesure de l'utilisation de ce système, vous vous rendrez compte qu'il manque quelque chose... En effet, les différents <em>steps</em> sont distincts les uns des autres, ne communiquant pas, ils ne peuvent pas utiliser les valeurs des autres <em>steps</em>.
Imaginons que vous souhaitez créer une formule "Early bird" et que celle-ci soit disponible uniquement jusqu'à une certaine date. Pour réaliser ce <em>step</em> il vous faudra donc soit créer un nouveau <em>step</em> qui permet de créer une formule avec une référence, un prix et une date de fin de disponibilité. Cela nous fait dupliquer une partie du code précédent et ce n'est pas forcément pertinent.</p>
<p>Pour éviter cela, il est intéresant de pouvoir récupérer un élément du <em>step</em> précédent dans le <em>step</em> suivant afin de modifier certaines valeurs.</p>
<p>Afin de réaliser cette tâche, nous avons ajouté un service qui sert de réceptacle de données entre nos <em>steps</em>.
Ce <em>Storage</em> contient simplement un tableau indexé par type de donnée stockée et nous offre l'accès à un getter et un setter pour récupérer ou écraser la donnée.</p>
<pre class="code-multiline"><code id="4d9c329ff84633c2d826e6bd1de99d9b">features/Behat/Storage/Storage.php</code></pre>
<pre class="code-multiline language-php"><code class="language-php" id="4bc9a6020de0d683d1049ccbc0b75bcd"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Storage</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Storage</span>
<span class="token punctuation">{</span>
    <span class="token doc-comment comment">/** <span class="token keyword">@var</span> <span class="token class-name"><span class="token keyword">array</span></span> */</span>
    <span class="token keyword">private</span> <span class="token variable">$storage</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">set</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">storage</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">storage</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>On peut ensuite injecter ce <em>storage</em> à notre <em>ProductProxy</em> et on pourra piocher dans les données pour les modifier.</p>
<pre class="code-multiline language-php"><code class="language-php" id="804d9cdf1fdf5f225dd33827085ad845"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Proxy</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductProxy</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$productManager</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$storage</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token class-name type-declaration">ProductManager</span> <span class="token variable">$productManager</span><span class="token punctuation">,</span>
        <span class="token class-name type-declaration">Storage</span> <span class="token variable">$storage</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productManager</span> <span class="token operator">=</span> <span class="token variable">$productManager</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">storage</span> <span class="token operator">=</span> <span class="token variable">$storage</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Storage</span>
    <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">storage</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>En repartant de notre test fonctionnel en Gherkin, nous pouvons donc avoir les <em>steps</em> suivantes:</p>
<pre class="code-multiline language-gherkin"><code class="language-gherkin" id="e46574ab9ae559bfe1a4f26a1f4dcac1"><span class="token scenario"><span class="token keyword">Scenario:</span><span class="token important"> I can not buy a plan with an availability date passed</span></span>
    <span class="token atrule">Given</span> the database is purged
    <span class="token atrule">And</span> there is a plan named <span class="token string">"Premium"</span> with a price of 100
    <span class="token atrule">And</span> this plan is not available anymore
    <span class="token atrule">And</span> the user <span class="token string">"user@example.net"</span> is created
    <span class="token atrule">And</span> <span class="token atrule">I</span> am logged with <span class="token string">"user@example.net"</span>
    <span class="token atrule">When</span> <span class="token atrule">I</span> go to this page <span class="token string">"/fr/buy"</span>
    <span class="token atrule">Then</span> <span class="token atrule">I</span> should see <span class="token string">"Premium"</span>
    <span class="token atrule">And</span> <span class="token atrule">I</span> can not buy <span class="token string">"Premium"</span></code></pre>
<p>Ce qui se retranscrirait dans le code du <em>ProductManager</em> et du <em>ProductContext</em> par:</p>
<pre class="code-multiline language-php"><code class="language-php" id="b976094873acb604f44ae68c12f50b3c"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Manager</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductManager</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$productRepository</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token class-name type-declaration">ProductRepositoryInterface</span> <span class="token variable">$productRepository</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productRepository</span> <span class="token operator">=</span> <span class="token variable">$productRepository</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createPlan</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$reference</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$price</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Product</span>
    <span class="token punctuation">{</span>
         <span class="token variable">$plan</span> <span class="token operator">=</span> <span class="token scope">Product<span class="token punctuation">::</span></span><span class="token function">createPlan</span><span class="token punctuation">(</span>
            <span class="token variable">$reference</span><span class="token punctuation">,</span>
            <span class="token variable">$price</span><span class="token punctuation">,</span>
            <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token number">100</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productRepository</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$plan</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// We now return the plan after the creation</span>
        <span class="token keyword">return</span> <span class="token variable">$plan</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setAvailability</span><span class="token punctuation">(</span>
        <span class="token class-name type-declaration">Product</span> <span class="token variable">$plan</span><span class="token punctuation">,</span>
        <span class="token operator">?</span><span class="token class-name class-name-fully-qualified type-declaration"><span class="token punctuation">\</span>DateTimeInterface</span> <span class="token variable">$availability</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token variable">$plan</span><span class="token operator">-&gt;</span><span class="token function">updateEndOfAvailability</span><span class="token punctuation">(</span><span class="token variable">$availability</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productRepository</span><span class="token operator">-&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token variable">$plan</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<pre class="code-multiline language-php"><code class="language-php" id="95ca6f88ed9ad2eadd142e325560a7f4"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Tests<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Behat<span class="token punctuation">\</span>Behat<span class="token punctuation">\</span>Context<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Webmozart<span class="token punctuation">\</span>Assert<span class="token punctuation">\</span>Assert</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductContext</span> <span class="token keyword">implements</span> <span class="token class-name">Context</span>
<span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * @Given there is a plan named :reference with a price of :price
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createPlan</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$reference</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$price</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// We receive the return of the createPlan function</span>
        <span class="token variable">$plan</span> <span class="token operator">=</span> <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productProxy</span>
            <span class="token operator">-&gt;</span><span class="token function">getProductManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">createPlan</span><span class="token punctuation">(</span><span class="token variable">$reference</span><span class="token punctuation">,</span> <span class="token variable">$price</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>

        <span class="token comment">// And we set the plan in the storage for further usage</span>
        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productProxy</span><span class="token operator">-&gt;</span><span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'plan'</span><span class="token punctuation">,</span> <span class="token variable">$plan</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

    <span class="token doc-comment comment">/**
     * @Given this plan is not available anymore
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">planNotAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// We retrieve the previous plan from the storage</span>
        <span class="token variable">$plan</span> <span class="token operator">=</span> <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productProxy</span><span class="token operator">-&gt;</span><span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'plan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this keyword">$this</span><span class="token operator">-&gt;</span><span class="token property">productProxy</span>
            <span class="token operator">-&gt;</span><span class="token function">getProductManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setAvailability</span><span class="token punctuation">(</span>
                <span class="token variable">$plan</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DateTime</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'1999-10-10 10:00:00.000'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>À la lecture de notre test fonctionnel, nous comprenons tout de suite dans quel contexte nous nous trouvons, avec une formule non disponible, et nous testons qu'elle n'est plus achetable par un utilisateur.</p>
<h2 id="axes-d-amelioration" class="anchor-title"><a href="#axes-d-amelioration">Axes d'amélioration 🚀</a></h2>
<p>Afin de rendre nos tests fonctionnels encore plus compréhensibles, nous avons de futurs axes d'amélioration comme pouvoir naviguer sur le site sans faire mention des urls qui n'ont pas toujours de notion métier.
Ce qui permettrait la rédaction de <em>steps</em> tel que:</p>
<pre class="code-multiline language-diff"><code class="language-diff" id="cdf5813eb74a194e4fa6ba939ea6d8a6"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> When I go to this page "/fr/buy"
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> When I go to the products list</span></span></code></pre>
<p>De même, la modification d'une entité peut se passer hors des <em>steps</em> prédéfinis par Mink qui remplissent un formulaire, en utilisant un <em>DataNode</em> contextualisé par exemple.</p>
<pre class="code-multiline language-diff"><code class="language-diff" id="596d0fbc6fe629b74acf1bc79b0ced14"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> And I fill in the following:
</span><span class="token prefix deleted">-</span><span class="token line">   | reference | Early bird |
</span><span class="token prefix deleted">-</span><span class="token line">   | price     | 20         |
</span><span class="token prefix deleted">-</span><span class="token line"> And I submit the form
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> And I modify this plan with
</span><span class="token prefix inserted">+</span><span class="token line">   | price     | 20         |
</span><span class="token prefix inserted">+</span><span class="token line">   | reference | Early bird |</span></span></code></pre>
<p>Mais tout ceci demande de coder tous les contextes, les <em>steps</em>, les <em>proxies</em>, ce qui est très verbeux. Cependant la valeur ajoutée d'avoir une bonne couverture de tests fonctionnels est importante et le temps passé à coder les tests est du temps gagné en débogage.</p>
<h2 id="en-conclusion" class="anchor-title"><a href="#en-conclusion">En conclusion 🎬</a></h2>
<p>Avant, nous avions beaucoup de tests avec des fixtures lourdes à maintenir qui cachaient une grande partie de ce qui était chargé. Nous avons maintenant des <em>steps</em> qui décrivent le contexte dans lequel le test s'effectue. Le code métier directement utilisé est plus maintenable.</p>
<p>Nos tests sont lisibles ce qui facilite la code review par nos pairs. Ils sont réutilisables pour différents contextes.</p>
                                                                </main>
            <aside class="article-content__aside">
                            </aside>
        </div>

        <div class="article-footer" data-aos="fade-in">
                                                <div class="article-author">
                        <div class="article-author__image">
                            <a>
                                <img     src="/elao_/pr/651/%2E%2E/../resized/content/images/members/avatars/ndievart.jpg/a74abe0a7281efd3b7446bf221cbb4f9.jpg"
    srcset="
        /elao_/pr/651/%2E%2E/../resized/content/images/members/avatars/ndievart.jpg/a74abe0a7281efd3b7446bf221cbb4f9.jpg 1x,
        /elao_/pr/651/%2E%2E/../resized/content/images/members/avatars/ndievart.jpg/0a5b8f386b3f9ef6ffd06c5654ceca72.jpg 2x
    "
 />
                            </a>
                        </div>
                        <span class="article-author__info">
                            Écrit par
                            <a>
                                <strong>Nicolas Dievart</strong>
                            </a>
                        </span>

                        <div class="article-author__social">
                                                                                        <a href="https://github.com/NicolasDievart " class="social social--small">
                                    <i class="icon icon--github" aria-hidden="true"></i>
                                    <span class="screen-reader">Compte github de Nicolas Dievart</span>
                                </a>
                                                                                        <a href="http://www.elao.com" class="social social--small">
                                    <i class="icon icon--website" aria-hidden="true"></i>
                                    <span class="screen-reader">Site personnel de Nicolas Dievart</span>
                                </a>
                                                    </div>
                    </div>
                                    </div>

                <div class="bricks">
            
                            <div class="brick-contribute">
                    <p>
                        Une typo ?
                        <a href="https://github.com/Elao/elao_/edit/refresh/content/blog/dev/ecrire-des-tests-behat-proches-de-son-domaine.md/" target="_blank" class="animated-link animated-link--light">
                            Modifier cet article sur Github
                        </a>
                    </p>
                </div>
                    </div>
            </div>
        </main>
                    
<footer class="footer">
    <div class="container">
        <section class="footer__links">
            <p class="h1">
                elao
                <span>développe</span>
                <span>du lien</span>
            </p>
            <div class="links">
                                    <ul>
                                                    <li>
                                <a href="/elao_/pr/651/nos-services/" >Services</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/651/demarche" >Démarche</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/651/etudes-de-cas" >Études de cas</a>
                            </li>
                                            </ul>
                                    <ul>
                                                    <li>
                                <a href="/elao_/pr/651/nos-valeurs" >Valeurs</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/651/equipe" >L&#039;équipe</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/651/blog" >Blog</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/651/blog/rss.xml"  data-no-swup="data-no-swup">RSS</a>
                            </li>
                                            </ul>
                                <ul>
                    <li>
                                                <a href="/elao_/pr/651/recrutement">
                            Nous recrutons
                                                            <span class="bullet">2</span>
                                                    </a>
                    </li>
                    <li>
                        <a href="/elao_/pr/651/glossaire/">Glossaire 🧐</a>
                    </li>
                    <li>
                        <a href="/elao_/pr/651/elaomojis">Elaomojis 🎉</a>
                    </li>
                </ul>
            </div>
            <div class="socials">
                <ul>
                    <li>
                        <a href="https://github.com/elao" target="_blank">
                            <i class="icon icon--github"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/elao" target="_blank">
                            <i class="icon icon--x"></i>
                            Twitter
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/company/elao/mycompany/" target="_blank">
                            <i class="icon icon--linkedin"></i>
                            Linkedin
                        </a>
                    </li>
                </ul>
            </div>
            <div class="contacts">
                <ul>
                    <li>
                        <a href="/elao_/pr/651/contact">Contact</a>
                    </li>
                    <li>
                        <a href="tel:04 82 53 37 19">04 82 53 37 19</a>
                    </li>
                    <li>
                        <a href="mailto:contact@elao.com">contact@elao.com</a>
                    </li>
                    <li>34 rue Jean Broquin</li>
                    <li>69006 Lyon</li>
                </ul>
            </div>
        </section>

        <section class="footer__legals">
            <span>© 2005 - 2025 - ELAO - Tous droits réservés</span>
            <a href="/elao_/pr/651/legal">Mentions légales</a>
            <a href="/elao_/pr/651/confidentialite">Protection des données</a>
            <a id="see" href="#ssss">🐍</a>
        </section>
    </div>
</footer>

            </body>
</html>
