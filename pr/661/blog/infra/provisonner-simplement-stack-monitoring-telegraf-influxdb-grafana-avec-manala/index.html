<!DOCTYPE html>
<html lang="fr" class="no-js">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana avec Manala</title>

        <!-- Favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="/elao_/pr/661/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/elao_/pr/661/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/elao_/pr/661/favicon-16x16.png">
        <link rel="manifest" href="/elao_/pr/661/site.webmanifest">
        <link rel="mask-icon" href="/elao_/pr/661/safari-pinned-tab.svg" color="#ff4344">
        <link rel="shortcut icon" href="/elao_/pr/661/favicon.ico">
        <meta name="msapplication-TileColor" content="#ff4344">
        <meta name="msapplication-config" content="/elao_/pr/661/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">

                    <meta name="description" content="Comment utiliser les roles Ansible de Manala pour provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana" />
            <link rel="canonical" href="https://elao.github.io/elao_/pr/661/blog/infra/provisonner-simplement-stack-monitoring-telegraf-influxdb-grafana-avec-manala" />

            <!-- Open Graph / Facebook -->
            <meta property="og:title" content="Provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana avec Manala" />
            <meta property="og:locale" content="fr" />
            <meta property="og:description" content="Comment utiliser les roles Ansible de Manala pour provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana" />
            <meta property="og:url" content="https://elao.github.io/elao_/pr/661/blog/infra/provisonner-simplement-stack-monitoring-telegraf-influxdb-grafana-avec-manala" />
            <meta property="og:site_name" content="elao_" />

                                        <meta property="og:image" content="https://elao.github.io/elao_/pr/661/%2E%2E/../resized/content/images/blog/thumbnails/grafana.jpg/8d54915cf790ee208a7ddd33298a6298.jpg">
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary_large_image">
            <meta property="twitter:title" content="Provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana avec Manala">
            <meta property="twitter:description" content="Comment utiliser les roles Ansible de Manala pour provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana">
            <meta property="twitter:site" content="@elao">
            <meta property="twitter:creator" content="@elao">
                                        <meta property="twitter:image" content="https://elao.github.io/elao_/pr/661/%2E%2E/../resized/content/images/blog/thumbnails/grafana.jpg/9b727c27ebe1456432b13e55c4daccea.jpg">
                            <link rel="alternate" type="application/rss+xml" href="/elao_/pr/661/blog/rss.xml" title="Le blog de l'équipe d'Elao" />
        
                <script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "Provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana avec Manala",
    "image": [
        "https://elao.github.io/elao_/pr/661/blog/infra/content/images/blog/thumbnails/grafana.jpg"
    ],
    "datePublished": "2017-01-25T00:00:00+00:00",
    "dateModified": "2017-01-25T00:00:00+00:00",
    "author": [
        {
            "@type": "Person",
            "name": "Maxime Colin",
            "url": "https://elao.github.io/elao_/pr/661/equipe/mcolin"
        }
    ],
    "keywords": [
        "Provisoning",
        "Manala",
        "Ansible",
        "Influxdb",
        "Grafana",
        "Telegraf",
        "Monitoring"
    ]
}
    </script>
    
                            <meta name="robots" content="noindex" />
        
        <script>
                        document.querySelector('html').classList.remove('no-js');
        </script>

                    <link rel="stylesheet" href="/elao_/pr/661/build/app.d7834fff.css">
        
                        <script src="/elao_/pr/661/build/runtime.3f493997.js" defer></script><script src="/elao_/pr/661/build/947.b56b79b1.js" defer></script><script src="/elao_/pr/661/build/769.7dfbbe52.js" defer></script><script src="/elao_/pr/661/build/app.e47fd89c.js" defer></script>

                    

    <script src="https://platform.twitter.com/widgets.js"></script>
    <script async defer src="//platform.instagram.com/en_US/embeds.js"></script>

    <script>
        window.onload = (function(){
            var tweets = document.querySelectorAll('.tweet-container');
            tweets.forEach(function(tweet) {
                // https://developer.twitter.com/en/docs/twitter-for-websites/embedded-tweets/guides/embedded-tweet-parameter-reference
                twttr.widgets.createTweet(tweet.getAttribute('data-tweet-id'), tweet, {
                    conversation: 'none',
                    cards: 'hidden',
                    theme: 'light',
                    lang: 'fr',
                    align: 'center',
                    width: 550, // default
                    dnt: true,
                })
            })
        });
    </script>

        <!-- S.E.E. -->
        <meta name="see" content="&#x5B;&quot;&#x5C;&#x2F;elao_&#x5C;&#x2F;pr&#x5C;&#x2F;661&#x5C;&#x2F;build&#x5C;&#x2F;see.80fe75b7.js&quot;&#x5D;">
        <meta name="see_style" content="&#x5B;&quot;&#x5C;&#x2F;elao_&#x5C;&#x2F;pr&#x5C;&#x2F;661&#x5C;&#x2F;build&#x5C;&#x2F;see.d77e78f8.css&quot;&#x5D;">
    </head>
    <body
        data-controller="swup-plugins symfony--ux-swup--swup swup-matomo" data-symfony--ux-swup--swup-containers-value="&#x5B;&quot;&#x23;main&quot;,&quot;&#x23;nav&quot;&#x5D;" data-symfony--ux-swup--swup-cache-value="true" data-symfony--ux-swup--swup-animate-history-browsing-value="true" data-symfony--ux-swup--swup-debug-value="false" data-symfony--ux-swup--swup-link-selector-value="a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;661&quot;&#x5D;&#x3A;not&#x28;&#x5B;data-no-swup&#x5D;&#x29;&#x3A;not&#x28;&#x5B;target&#x3D;&quot;_blank&quot;&#x5D;&#x29;&#x3A;not&#x28;a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;661&#x2F;_profiler&quot;&#x5D;&#x29;,a&#x5B;href&#x5E;&#x3D;&quot;&#x2F;&quot;&#x5D;&#x3A;not&#x28;&#x5B;data-no-swup&#x5D;&#x29;&#x3A;not&#x28;&#x5B;target&#x3D;&quot;_blank&quot;&#x5D;&#x29;&#x3A;not&#x28;a&#x5B;href&#x5E;&#x3D;&quot;https&#x3A;&#x2F;&#x2F;elao.github.io&#x2F;elao_&#x2F;pr&#x2F;661&#x2F;_profiler&quot;&#x5D;&#x29;" data-swup-matomo-enabled-value="false">
                    <header id="nav" class="header">
                <div class="container">
                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/pr/661/">
                        <span class="screen-reader">Provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana avec Manala</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>

                                            <!-- Desktop nav -->
                        <nav class="nav">
                            <ul>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/661/nos-services/">
                                                                                        <span>Services</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/661/demarche">
                                                                                        <span>Démarche</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/661/etudes-de-cas">
                                                                                        <span>Études de cas</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/661/nos-valeurs">
                                                                                        <span>Valeurs</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/661/equipe">
                                                                                        <span>L&#039;équipe</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item nav__item--active">
                                        <a href="/elao_/pr/661/blog">
                                                                                        <span>Blog</span>
                                        </a>
                                    </li>
                                                                    <li class="nav__item ">
                                        <a href="/elao_/pr/661/contact">
                                                                                            <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                        <span>Contact</span>
                                        </a>
                                    </li>
                                                            </ul>
                        </nav>
                    
                                            <!-- Mobile nav -->
                        <nav class="nav-mobile" data-controller="toggle">
                            <div class="nav-mobile__header">
                                <a href="/elao_/pr/661/">
                                                                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                                </a>
                                <button class="nav-toggle nav-toggle--close">
                                    <i class="icon icon--close" aria-hidden="true"></i>
                                    <span class="screen-reader">Fermer le menu</span>
                                </button>
                            </div>
                            <ul>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/661/nos-services/">
                                                                                        <span>Services</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/661/demarche">
                                                                                        <span>Démarche</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/661/etudes-de-cas">
                                                                                        <span>Études de cas</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/661/nos-valeurs">
                                                                                        <span>Valeurs</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  ">
                                        <a href="/elao_/pr/661/equipe">
                                                                                        <span>L&#039;équipe</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item nav-mobile__item--active ">
                                        <a href="/elao_/pr/661/blog">
                                                                                        <span>Blog</span>
                                        </a>
                                    </li>
                                                                    <li class="nav-mobile__item  nav-mobile__item--large">
                                        <a href="/elao_/pr/661/contact">
                                                                                            <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                        <span>Contact</span>
                                        </a>
                                    </li>
                                                            </ul>
                        </nav>
                        <button class="nav-toggle nav-toggle--open">
                            <i class="icon icon--hamburger" aria-hidden="true"></i>
                            <span class="screen-reader">Ouvrir le menu</span>
                        </button>
                                    </div>
            </header>
                <main id="main">
                <div class="container">
                                <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
            <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/661/">
                <span itemprop="name">Accueil</span>
            </a>
            <meta itemprop="position" content="1" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/661/blog">
                <span itemprop="name">Blog</span>
            </a>
            <meta itemprop="position" content="2" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/elao_/pr/661/blog/infra">
                <span itemprop="name">Infra</span>
            </a>
            <meta itemprop="position" content="3" />
        </li>        <li class="breadcrumb__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="#">
                <span itemprop="name">Provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana avec Manala</span>
            </a>
            <meta itemprop="position" content="4" />
        </li></ol>

        
        <div class="article-banner">
            <div
                class="article-banner__cover"
                style="background: #f1f1f1 url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/9ed32758d8feffd248330ed763a409f9.jpg');
    background: #f1f1f1 -webkit-image-set(
        url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/9ed32758d8feffd248330ed763a409f9.jpg') 1x,
        url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/62691a48e81b34ae6d3be238a1e1c0da.jpg') 2x
    );
    background: #f1f1f1 -moz-image-set(
        url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/9ed32758d8feffd248330ed763a409f9.jpg') 1x,
        url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/62691a48e81b34ae6d3be238a1e1c0da.jpg') 2x
    );
    background: #f1f1f1 -ms-image-set(
        url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/9ed32758d8feffd248330ed763a409f9.jpg') 1x,
        url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/62691a48e81b34ae6d3be238a1e1c0da.jpg') 2x
    );
    background: #f1f1f1 image-set(
        url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/9ed32758d8feffd248330ed763a409f9.jpg') 1x,
        url('/elao_/pr/661/%2E%2E/../resized/content/images/blog/headers/grafana.jpg/62691a48e81b34ae6d3be238a1e1c0da.jpg') 2x
    );"
                data-aos="fade-down"
            ></div>

            <div class="article-info" data-aos="zoom-in">
                                                    <div class="article-author ">
                        <div class="article-author__image">
                                                            <a href="/elao_/pr/661/blog/auteur/mcolin">
                                    <img     src="/elao_/pr/661/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg"
    srcset="
        /elao_/pr/661/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg 1x,
        /elao_/pr/661/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/0899bdf7169af336de983de73d88fa58.jpg 2x
    "
 />
                                </a>
                                                    </div>
                        <span class="article-author__info">
                            Écrit par
                                                            <a href="/elao_/pr/661/blog/auteur/mcolin">
                                    <strong>Maxime Colin</strong>
                                </a>
                                                    </span>
                    </div>
                                <div class="article-info__date">
                    <span>Publication <strong>25 janvier 2017</strong></span>
                                                        </div>
            </div>

            <div class="article-header" data-aos="zoom-in-up">
                <h1>Provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana avec Manala</h1>
                <p>Comment utiliser les roles Ansible de Manala pour provisionner simplement une stack de monitoring Telegraf + InfluxDB + Grafana</p>
                <ul class="article-tag-list">
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/661/blog/tag/provisoning" rel="nofollow">#Provisoning</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/661/blog/tag/manala" rel="nofollow">#Manala</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/661/blog/tag/ansible" rel="nofollow">#Ansible</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/661/blog/tag/influxdb" rel="nofollow">#Influxdb</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/661/blog/tag/grafana" rel="nofollow">#Grafana</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/661/blog/tag/telegraf" rel="nofollow">#Telegraf</a>
                        </li>
                                            <li class="article-tag-list__item">
                            <a href="/elao_/pr/661/blog/tag/monitoring" rel="nofollow">#Monitoring</a>
                        </li>
                                    </ul>
            </div>
        </div>

                    <ol class="table-of-content" data-aos="fade-up">
                                    <li class="table-of-content__item">
                        <a href="#manala">Manala</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#pourquoi-monitorer">Pourquoi monitorer</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#la-stack">La stack</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#provisonning">Provisonning</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#prise-en-main">Prise en main</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#pour-aller-plus-loin">Pour aller plus loin</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#en-production">En production</a>

                                            </li>
                                    <li class="table-of-content__item">
                        <a href="#conclusion">Conclusion</a>

                                            </li>
                            </ol>
        
        <div class="article-content">
            <main class="article-content__main">

                
                
                <h2 id="manala" class="anchor-title"><a href="#manala">Manala</a></h2>
<p><a href="http://www.manala.io/" target="_blank">Manala</a> est la boîte à outils pour <a href="https://www.ansible.com/" target="_blank">Ansible</a> créée par <a href="https://www.elao.com/" target="_blank">Elao</a>. Elle se compose d'une multitude de rôles <strong>Ansible</strong> pensés autour de la même philosophie : une installation et une configuration simple d'un environnement serveur.</p>
<p>Si vous n'êtes pas famillier avec <strong>Ansible</strong>, je vous encourage à <a href="http://docs.ansible.com/ansible/index.html" target="_blank">découvrir ce magnifique outil</a>.</p>
<h2 id="pourquoi-monitorer" class="anchor-title"><a href="#pourquoi-monitorer">Pourquoi monitorer</a></h2>
<p>Le <strong>monitoring</strong> consiste à surveiller et logger une série de métriques dans le temps et de les représenter sous forme de graphiques. Le monitoring vous permet de détecter voir d'anticiper des anomalies ou des pannes, que ce soit de votre infrastucture ou de votre applicatif.</p>
<p>Le <strong>monitoring</strong> peut vous permettre de déclencher des alertes sur certains seuils de <strong>métriques</strong> afin de réagir avant qu'un problème devienne critique.</p>
<p>Celà peut être :</p>
<ul>
<li>un pic de charge important indiquant un problème de performance ou un pic de visiteurs</li>
<li>un pic de trafic anormal causé par une attaque</li>
<li>à l'inverse une perte soudaine de traffic pouvant indiquer une panne ou une indisponibilité</li>
<li>...</li>
</ul>
<p>Vous pouvez également mesurer un gain ou une perte de <strong>performance</strong> à la suite d'une mise à jour.</p>
<p>En conclusion, le monitoring permet de <strong>surveiller</strong> la santé de votre serveur/application.</p>
<h2 id="la-stack" class="anchor-title"><a href="#la-stack">La stack</a></h2>
<h3 id="telegraf" class="anchor-title"><a href="#telegraf">Telegraf</a></h3>
<p><a href="https://www.influxdata.com/time-series-platform/telegraf/" target="_blank">Telegraf</a> est un collecteur de données créé par les créateurs d'<strong>InfluxDB</strong> : <a href="https://www.influxdata.com/" target="_blank">InfluxData</a>. Il permet de collecter des données systèmes (CPU, mémoire, I/O, disque, ...) et dispose de très nombreux plugins <a href="https://github.com/influxdata/telegraf#input-plugins" target="_blank">d'entrées</a> (pour collecter) et <a href="https://github.com/influxdata/telegraf#output-plugins" target="_blank">de sortie</a> (pour stocker).</p>
<h3 id="influxdb" class="anchor-title"><a href="#influxdb">InfluxDB</a></h3>
<p><a href="https://www.influxdata.com/time-series-platform/influxdb/" target="_blank">InfluxDB</a> est une base de données écrite en Go spécialisée dans le stockage de métriques et d'événements. Egalement développé par <a href="https://www.influxdata.com/" target="_blank">InfluxData</a>, l'intégration avec <strong>Telegraf</strong> est très facile.</p>
<h3 id="grafana" class="anchor-title"><a href="#grafana">Grafana</a></h3>
<p><a href="http://grafana.org/" target="_blank">Grafana</a> est une des références parmis les dashboards de métriques. Il permet de réaliser des graphiques à partir d'une multitudes de sources de données.</p>
<p>A partir de la version 4, Grafana permet également de faire de l'alerting basique grâce à un système de <a href="http://docs.grafana.org/alerting/rules/" target="_blank">règles</a> et de <a href="http://docs.grafana.org/alerting/notifications/" target="_blank">notifications</a>.</p>
<h2 id="provisonning" class="anchor-title"><a href="#provisonning">Provisonning</a></h2>
<h3 id="playbook" class="anchor-title"><a href="#playbook">Playbook</a></h3>
<p>Vous devez installer les rôles suivants grâce à <a href="https://galaxy.ansible.com/intro" target="_blank">Ansible Galaxy</a> :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="ed6f6ee98a079aa6aa3a0250591713b0"><span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> manala.apt
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> manala.telegraf
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> manala.influxdb
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> manala.grafana</code></pre>
<p>puis les ajouter à votre playbook :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="cb7f55556b6e5736f0fe4bf1fbd12272"><span class="token punctuation">---</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> manala.apt
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> manala.influxdb
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> manala.telegraf
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> manala.grafana</code></pre>
<div style="border-left: 5px solid #ffa600;padding: 20px;margin: 20px 0;">
    Attention, jouez bien les rôles dans cet ordre là. Le rôle <code id="4b28d28900b5c98745e8d7c15717db0d">manala.apt</code> doit être en premier car il va configurer les dépots. Telegraf doit être installé après InfluxDB car il va y créer sa base de données.
</div>
<h3 id="configuration" class="anchor-title"><a href="#configuration">Configuration</a></h3>
<p>Dans <code class="code-inline" id="96fa973cda8809ad84f646e3d8fbbc1c">group_vars</code>, la configuration suivante permet d'indiquer que nous souhaitons installer InfluxDB, Telegraf et Grafana via les dépôts <code class="code-inline" id="792d46d72f3bc786f0d9f73d55e3121d">influxdata</code> et <code class="code-inline" id="d9c0e52dd15274d51041b489c7cea0ad">grafana</code>.</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="92086c8f7e6e003b165c57c190fd7650"><span class="token key atrule">manala_apt_preferences</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> influxdb@influxdata
  <span class="token punctuation">-</span> telegraf@influxdata
  <span class="token punctuation">-</span> grafana@grafana</code></pre>
<p>Il faut ensuite configurer le rôle <a href="https://github.com/manala/ansible-role-telegraf" target="_blank">manala.telegraf</a> :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="8be8a3ac7f670293105ac4223890b4e6"><span class="token key atrule">manala_telegraf_configs_exclusive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">manala_telegraf_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     output_influxdb.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/output_influxdb.conf.j2
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">urls</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://localhost:8086"</span><span class="token punctuation">]</span>
      <span class="token punctuation">-</span> <span class="token key atrule">database</span><span class="token punctuation">:</span> telegraf
      <span class="token punctuation">-</span> <span class="token key atrule">username</span><span class="token punctuation">:</span> telegraf
      <span class="token punctuation">-</span> <span class="token key atrule">password</span><span class="token punctuation">:</span> password

  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     input_system.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/input_system.conf.j2

  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     input_cpu.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/input_cpu.conf.j2

  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     input_mem.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/input_mem.conf.j2

  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     input_disk.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/input_disk.conf.j2

  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     input_diskio.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/input_disk.conf.j2

  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     input_net.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/input_net.conf.j2</code></pre>
<p>La configuration du fichier <code class="code-inline" id="bcb27117aa4a499ab27bda71df24b85b">output_influxdb.conf</code> indique sur quel support de stockage <strong>Telegraf</strong> doit envoyer les données collectées. Ici on indique l'url de API d'<strong>InfluxDB</strong> ainsi que le nom et les identifiants de la base de données à utiliser.</p>
<p>Les fichiers <code class="code-inline" id="98816dd26aaf01abfccd406c74b69f50">input_*.conf</code> suivants permettent de configurer les métriques à collecter. Le rôle est fourni avec des fichiers de configurations pour les plusieurs métriques mais vous pouvez ajouter vos propres fichiers de configuration.</p>
<ul>
<li>cpu</li>
<li>disk</li>
<li>diskio</li>
<li>haproxy</li>
<li>mem</li>
<li>net</li>
<li>swap</li>
<li>system</li>
</ul>
<p>Les rôles <a href="https://github.com/manala/ansible-role-influxdb" target="_blank">manala.influxdb</a> et <a href="https://github.com/manala/ansible-role-grafana" target="_blank">manala.grafana</a> ne nécessitent pas de configuration particulière pour fonctionner.</p>
<p>Je vous encourage néanmoins à jeter un oeil à la configuration de ces deux rôles si vous souhaitez aller plus loin, notamment concernant la sécurité des deux outils ou l'activation de fonctionnalités de Grafana.</p>
<h2 id="prise-en-main" class="anchor-title"><a href="#prise-en-main">Prise en main</a></h2>
<h3 id="influxdb" class="anchor-title"><a href="#influxdb">InfluxDB</a></h3>
<p>InfluxDB dispose d'une interface en ligne de commandes à la manière de <code class="code-inline" id="81c3b080dad537de7e10e0987a4bf52e">mysql</code> pour exécuter des requêtes. Si vous vous connectez en SSH à la machine que vous avez provisonnée, vous devriez pouvoir l'interroger. Vous pouvez par exemple lister les métriques de la base de données "telegraf".</p>
<pre class="code-multiline language-bash"><code class="language-bash" id="65b3939b3136f5f6240a6ced9d3f5c9a">$ influx <span class="token parameter variable">-execute</span> <span class="token string">'SHOW MEASUREMENTS'</span> <span class="token parameter variable">-database</span><span class="token operator">=</span><span class="token string">"telegraf"</span>
name: measurements
name
----
cpu
disk
diskio
kernel
mem
net
processes
swap
system</code></pre>
<p>Vous devriez voir la liste des métriques que vous aviez configurées plus haut dans le rôle <code class="code-inline" id="20d6dae70fa07e191112ecf9837b1d1f">manala.telegraf</code></p>
<div style="border-left: 5px solid #ffa600;padding: 20px;margin: 20px 0;">
    Je ne parle intentionnellement pas de l'interface web d'InfluxDB habituellement disponible sur le port 8083 car celle-ci est <a href="https://docs.influxdata.com/influxdb/v1.1/administration/differences/#deprecations" target="_blank">actuellement dépréciée et désactivée par défaut</a> (version 1.1) et disparaîtra des versions suivantes.
</div>
<h3 id="grafana" class="anchor-title"><a href="#grafana">Grafana</a></h3>
<p>Par defaut <strong>Grafana</strong> est accesible sur le port <code class="code-inline" id="e93028bdc1aacdfb3687181f2031765d">3000</code> avec pour identifiant et mot de passe "admin" / "admin". Vous accédez alors au "Home Dashboard". Avant toute chose il faut ajouter notre base de données InfluxDB comme source de données. Pour cela dans le menu, sélectionnez <em>Data Sources</em> puis <em>Add data source</em>. Nommez votre source, sélectionnez le type "InfluxDB", renseignez l'url <code class="code-inline" id="dc5025de8b60c0a511df7c07d81ead97">http://localhost:8086</code> et le nom de base de données <code class="code-inline" id="aa3a0177193f5479812eadbbb3e6c303">telegraf</code>. Par défaut il n'y a pas d'identifiant ni de mot de passe sur la base de données. Cliquez sur <em>Save and test</em> et si tout va bien vous devriez obtenir le message <em>Data source is working</em>.</p>
<p>À partir de là vous pouvez créer votre premier <em>dashboard</em> (Menu &gt; Dashboard &gt; New). Pour avoir rapidement une base, vous pouvez également importer (Menu &gt; Dashboard &gt; Import) <a href="https://gist.github.com/maximecolin/ae5876ff844ce6a5dca95bc179bfa72d" target="_blank">cette configuration de dashboard</a> que j'ai initiée pour vous.</p>
<figure>
    <img src="/elao_/pr/661/%2E%2E/../resized/content/images/blog/2016/monitoring-grafana.jpg/dcae9248aa1dc2d07638ccf724b63b21.jpg" alt="Dashboard Grafana de monitoring système" srcset="/elao_/pr/661/%2E%2E/../resized/content/images/blog/2016/monitoring-grafana.jpg/dcae9248aa1dc2d07638ccf724b63b21.jpg 1x,
/elao_/pr/661/%2E%2E/../resized/content/images/blog/2016/monitoring-grafana.jpg/eb3ed0b274362118add1d94015120ff1.jpg 2x," id="dashboard-grafana-de-monitoring-systeme">
    <figcaption style="text-align:center;font-style:italic;">Dashboard Grafana de monitoring système</figcaption>
</figure>
<h2 id="pour-aller-plus-loin" class="anchor-title"><a href="#pour-aller-plus-loin">Pour aller plus loin</a></h2>
<h3 id="provisionner-les-datasources-et-les-dashboards" class="anchor-title"><a href="#provisionner-les-datasources-et-les-dashboards">Provisionner les datasources et les dashboards</a></h3>
<p>Une fois que vous avez configuré vos <em>datasources</em> et créé vos <em>dashboards</em> vous souhaiterez peut-être de les intégrer à votre provisonning afin d'automatiser leur configuration. Le rôle <code class="code-inline" id="78a7e4f03532bd610f8f5189864031e3">manala.grafana</code> permet celà.</p>
<p>Pour configurer une <em>datasource</em>, renseignez les mêmes informations que dans le formulaire de l'administration de <strong>Grafana</strong> :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="1072360ccbbae5698e6b70b4357048b4"><span class="token key atrule">manala_grafana_datasources_exclusive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">manala_grafana_datasources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>      telegraf
    <span class="token key atrule">type</span><span class="token punctuation">:</span>      influxdb
    <span class="token key atrule">isDefault</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">access</span><span class="token punctuation">:</span>    proxy
    <span class="token key atrule">basicAuth</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span>       http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8086</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span>  telegraf
    <span class="token key atrule">username</span><span class="token punctuation">:</span>  <span class="token string">''</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span>  <span class="token string">''</span></code></pre>
<p>Pour configurer un <em>dahsboard</em>, indiquez le chemin vers le fichier d'export JSON du dashboard et renseignez les <code class="code-inline" id="1ca5dc4d08e08c415746526489093d16">intputs</code> utilisés par celui-ci :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="a2514bf1f1364ebecabec494053ede76"><span class="token key atrule">manala_grafana_dashboards_exclusive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">manala_grafana_dashboards</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token string">"{{ playbook_dir }}/templates/grafana/dashboards/system.json"</span>
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>     <span class="token string">"DS_TELEGRAF"</span>
          <span class="token key atrule">pluginId</span><span class="token punctuation">:</span> <span class="token string">"influxdb"</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span>     <span class="token string">"datasource"</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span>    <span class="token string">"telegraf"</span>
      <span class="token key atrule">overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>
<p>Cette configuration va associer l'<em>input</em> "DS_TELEGRAF" du dashboard à la source <code class="code-inline" id="d4e0a564e2a8ab5a97797191488eada4">influxdb</code> de type <code class="code-inline" id="1ea7e575defdf6bc3f26a3f127e98170">datasource</code> nommée <code class="code-inline" id="aa3a0177193f5479812eadbbb3e6c303">telegraf</code>, c'est à dire la source créée juste au dessus. Si vous importez d'autres dashboards, prenez bien soin de regarder les <em>inputs</em> requis et associez-les de la même manière à vos <code class="code-inline" id="f96e94253fed6ae65d15a0616bcb8ed9">datasources</code>.</p>
<h3 id="proxy-pass" class="anchor-title"><a href="#proxy-pass">Proxy pass</a></h3>
<p>Si vous destinez votre instance de <strong>Grafana</strong> à des utilisateurs par forcement technique, il peut être intéressant d'avoir une url une peu plus sexy qu'un numéro de port à la fin de votre domaine. Vous pouvez opter pour un sous-domaine ou un chemin dédié en <a href="http://docs.grafana.org/installation/behind_proxy/" target="_blank">plaçant <strong>Grafana</strong> derrière un reverse proxy</a>.</p>
<p>Vous pouvez configurer un reverse proxy grâce au rôle <a href="https://github.com/manala/ansible-role-nginx" target="_blank">manala.nginx</a>.</p>
<p>Par exemple pour exposer <strong>Grafana</strong> sur l'url <code class="code-inline" id="7fc2a1f9faac0682a02e1251d1dda13f">http://grafana.foobar.com</code> :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="1b15adbdff1a13e1e06325bac969faea"><span class="token key atrule">manala_nginx_config_template</span><span class="token punctuation">:</span> config/http.<span class="token punctuation">{</span><span class="token punctuation">{</span> _env <span class="token punctuation">}</span><span class="token punctuation">}</span>.j2

<span class="token key atrule">manala_nginx_configs_exclusive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">manala_nginx_configs</span><span class="token punctuation">:</span>
  <span class="token comment"># Grafana</span>
  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     grafana.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/server.<span class="token punctuation">{</span><span class="token punctuation">{</span> _env <span class="token punctuation">}</span><span class="token punctuation">}</span>.j2
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">server_name</span><span class="token punctuation">:</span> grafana.foobar.com
      <span class="token punctuation">-</span> <span class="token key atrule">location /</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">proxy_pass</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">3000</span></code></pre>
<p>Il faut également indiquer le domaine à <strong>Grafana</strong> en ajoutant la configuration suivante :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="e044e1655673bad961f94c7a01402378"><span class="token key atrule">manala_grafana_config</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">domain</span><span class="token punctuation">:</span> grafana.foobar</code></pre>
<h3 id="securiser-grafana" class="anchor-title"><a href="#securiser-grafana">Sécuriser Grafana</a></h3>
<p>Une première mesure consiste à changer l'identifiant et le mot de passe administrateur de <strong>Grafana</strong> et désactiver la création de compte. Dans votre fichier de configuration <strong>Ansible</strong> :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="90c841f089e10ee8bb9bfc9d4ad24c80"><span class="token key atrule">manala_grafana_config</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">admin_user</span><span class="token punctuation">:</span> foobar
    <span class="token punctuation">-</span> <span class="token key atrule">admin_password</span><span class="token punctuation">:</span> foobar
  <span class="token punctuation">-</span> <span class="token key atrule">users</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">allow_sign_up</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>
<div style="border-left: 5px solid #ffa600;padding: 20px;margin: 20px 0;">
    Attention, l'utilisateur administrateur est créé au premier démarrage de <strong>Grafana</strong>, vous ne pourrez donc pas changer son identifiant ou son mot de passe via la configuration après le premier provisioning. Vous devrez alors passer par la page <em>profile</em> dans l'interface de <strong>Grafana</strong>.
</div>
<p>Il est possible de mettre en place des systèmes d'authentification tiers comme Google, GitHub ou votre propre OAuth.</p>
<p>Vous pouvez également changer le port de l'interface web qui est à <code class="code-inline" id="e93028bdc1aacdfb3687181f2031765d">3000</code> par defaut :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="65876736d12c71386bb13f869b64e97b"><span class="token key atrule">manala_grafana_config</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">http_port</span><span class="token punctuation">:</span> <span class="token number">3000</span></code></pre>
<p>Pour une configuration encore plus poussée, vous pouvez lire la <a href="http://docs.grafana.org/installation/configuration/" target="_blank">documentation de Grafana</a>.</p>
<h3 id="securiser-influxdb" class="anchor-title"><a href="#securiser-influxdb">Sécuriser InfluxDB</a></h3>
<p>Si vous laissez <strong>Telegraf</strong> créer sa propre base de données <strong>InfluxDB</strong>, celle-ci n'aura pas de mot de passe. Vous avez la possibilité de sécuriser votre base de données si vous le souhaitez, la configuration du rôle <code class="code-inline" id="5566d50300baae6d3777a0627bb71404">manala.influxdb</code> permet de gérer les utilisateurs et les permissions.</p>
<p>Par exemple vous pouvez ajouter un utilisateur <em>telegraf</em> qui a les droit d'écriture/lecture et un utilisateur <em>grafana</em> qui n'a que le droit de lecture</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="8ba5d00f7b612ce1aed181c863bb260f"><span class="token key atrule">manala_influxdb_databases</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> telegraf

<span class="token key atrule">manala_influxdb_users</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">database</span><span class="token punctuation">:</span> telegraf
    <span class="token key atrule">name</span><span class="token punctuation">:</span>     telegraf
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nYhvEVsku
  <span class="token punctuation">-</span> <span class="token key atrule">database</span><span class="token punctuation">:</span> telegraf
    <span class="token key atrule">user</span><span class="token punctuation">:</span>     grafana
    <span class="token key atrule">password</span><span class="token punctuation">:</span> fCCWkXemR

<span class="token key atrule">manala_influxdb_privileges</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">database</span><span class="token punctuation">:</span> telegraf
    <span class="token key atrule">user</span><span class="token punctuation">:</span>     telegraf
    <span class="token key atrule">grant</span><span class="token punctuation">:</span>    ALL
  <span class="token punctuation">-</span> <span class="token key atrule">database</span><span class="token punctuation">:</span> telegraf
    <span class="token key atrule">user</span><span class="token punctuation">:</span>     grafana
    <span class="token key atrule">grant</span><span class="token punctuation">:</span>    READ</code></pre>
<p>N'oubliez pas ensuite de renseigner les <em>username</em> et <em>password</em> dans la configuration de <strong>Telegraf</strong> :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="e768457ce1ef77ee134285314d560e80"><span class="token key atrule">manala_telegraf_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     output_influxdb.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/output_influxdb.conf.j2
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">urls</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://localhost:8086"</span><span class="token punctuation">]</span>
      <span class="token punctuation">-</span> <span class="token key atrule">database</span><span class="token punctuation">:</span> telegraf
      <span class="token punctuation">-</span> <span class="token key atrule">username</span><span class="token punctuation">:</span> telegraf
      <span class="token punctuation">-</span> <span class="token key atrule">password</span><span class="token punctuation">:</span> nYhvEVsku</code></pre>
<p>et dans la <em>datasource</em> de <strong>Grafana</strong> :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="35c883aa946963cef4629c0d7961cbf0"><span class="token key atrule">manala_grafana_datasources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>      telegraf
    <span class="token key atrule">type</span><span class="token punctuation">:</span>      influxdb
    <span class="token key atrule">isDefault</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">access</span><span class="token punctuation">:</span>    proxy
    <span class="token key atrule">basicAuth</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span>       http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8086</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span>  telegraf
    <span class="token key atrule">username</span><span class="token punctuation">:</span>  grafana
    <span class="token key atrule">password</span><span class="token punctuation">:</span>  fCCWkXemR</code></pre>
<h2 id="en-production" class="anchor-title"><a href="#en-production">En production</a></h2>
<h3 id="diviser-pour-mieux-regner" class="anchor-title"><a href="#diviser-pour-mieux-regner">Diviser pour mieux régner</a></h3>
<p>Pour l'article et dans un soucis de simplicité, je vous ai fait installer l'ensemble des outils sur le même serveur. Généralement, en production, on sépare le collecteur (Telegraf) de la persistance (InfluxDB) et de l'exploitation des données (Grafana) et ce pour des raisons de performance et de disponibilité.</p>
<p>Et oui, si votre serveur éprouve quelques difficulés, vous aimeriez bien qu'il n'en soit pas de même pour votre dashboard. Un monitoring qui tombe en panne en même temps que le serveur qu'il surveille n'a plus aucun intérêt.</p>
<p>Concernant les performances, selon la volumétrie de données que vous enregistrez, l'impact peut être non négligeable voire important. Il vaut donc mieux traiter les données sur un serveur à part.</p>
<h3 id="configuration" class="anchor-title"><a href="#configuration">Configuration</a></h3>
<p>Concernant l'installation, pas de grande différence, il suffit de reprendre le provisionning ci-dessus et de répartir sur deux playbook, l'un pour le serveur à monitorer avec Telegraf, l'autre pour le serveur de données avec InfluxDB et Grafana. La difficulté sera de permettre à Telegraf d'envoyer ses métriques à un autre serveur.</p>
<p>On va également en profiter pour passer du protocole <code class="code-inline" id="293c9ea246ff9985dc6f62a650f78986">HTTP</code> au protocole <code class="code-inline" id="f5ef036b4d8b630721e51fe23489fbc9">UDP</code> plus léger :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="7c987c2f5c7a6647942c15e79f46379f"><span class="token key atrule">manala_influxdb_config</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">reporting-disabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">udp</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">bind-address</span><span class="token punctuation">:</span> <span class="token punctuation">:</span><span class="token number">8090</span>
    <span class="token punctuation">-</span> <span class="token key atrule">database</span><span class="token punctuation">:</span> telegraf
    <span class="token punctuation">-</span> <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">5000</span>
    <span class="token punctuation">-</span> <span class="token key atrule">batch-timeout</span><span class="token punctuation">:</span> 1s
    <span class="token punctuation">-</span> <span class="token key atrule">batch-pending</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token punctuation">-</span> <span class="token key atrule">read-buffer</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>
<p>puis renseigner l'ip (ou le domaine) du serveur <strong>InfluxDB</strong> dans la configuration de <strong>Telegraf</strong> :</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="874c31b1a70c8c66c1db8b97cb9d5c0e"><span class="token key atrule">manala_telegraf_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>     output_influxdb.conf
    <span class="token key atrule">template</span><span class="token punctuation">:</span> configs/output_influxdb.conf.j2
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">urls</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"udp://123.234.56.78:8086"</span><span class="token punctuation">]</span>
      <span class="token punctuation">-</span> <span class="token key atrule">database</span><span class="token punctuation">:</span> telegraf
      <span class="token punctuation">-</span> <span class="token key atrule">username</span><span class="token punctuation">:</span> telegraf
      <span class="token punctuation">-</span> <span class="token key atrule">password</span><span class="token punctuation">:</span> nYhvEVsku</code></pre>
<div style="border-left: 5px solid #ffa600;padding: 20px;margin: 20px 0;">
  Attention, il est recommandé de placer votre endpoint InfluxDB derrière un firewall si l'interface est publique et de le configurer pour accepter le traffic entrant pour le port 8086 uniquement depuis l'IP du serveur monitoré. Pour cela vous pouvez utiliser le role <a href="https://github.com/manala/ansible-role-shorewall" target="_blank">manala.shorewall</a>.
</div>
<h2 id="conclusion" class="anchor-title"><a href="#conclusion">Conclusion</a></h2>
<p>Grâce aux rôles de <a href="http://www.manala.io/" target="_blank">Manala</a> j'ai pu créer simplement le provisonning d'une stack de monitoring en <a href="https://gist.github.com/maximecolin/acf6dd12dff72640a2b224cbb3934c4d" target="_blank">moins de 100 lignes de configuration</a>. Au besoin, grâce au provisonning, je peux répliquer cette stack sur n'importe quel serveur en quelques minutes.</p>
                                                                </main>
            <aside class="article-content__aside">
                            </aside>
        </div>

        <div class="article-footer" data-aos="fade-in">
                                                <div class="article-author">
                        <div class="article-author__image">
                            <a href="/elao_/pr/661/blog/auteur/mcolin">
                                <img     src="/elao_/pr/661/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg"
    srcset="
        /elao_/pr/661/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/cb69b0afe176d65ea7c1da7e712cac13.jpg 1x,
        /elao_/pr/661/%2E%2E/../resized/content/images/members/avatars/mcolin.jpg/0899bdf7169af336de983de73d88fa58.jpg 2x
    "
 />
                            </a>
                        </div>
                        <span class="article-author__info">
                            Écrit par
                            <a href="/elao_/pr/661/blog/auteur/mcolin">
                                <strong>Maxime Colin</strong>
                            </a>
                        </span>

                        <div class="article-author__social">
                                                            <a
                                    href="https://twitter.com/colin_maxime"
                                    target="_blank"
                                    rel="noreferrer"
                                    class="social social--small"
                                >
                                    <i class="icon icon--x" aria-hidden="true"></i>
                                    <span class="screen-reader">Compte Twitter de Maxime Colin</span>
                                </a>
                                                                                        <a
                                    href="https://bsky.app/profile/maximecolin.bsky.social"
                                    target="_blank"
                                    rel="noreferrer"
                                    class="social social--small"
                                >
                                    <i class="icon icon--bluesky" aria-hidden="true"></i>
                                    <span class="screen-reader">Compte Bluesky de Maxime Colin</span>
                                </a>
                                                                                        <a
                                    href="https://github.com/maximecolin"
                                    target="_blank"
                                    rel="noreferrer"
                                    class="social social--small"
                                >
                                    <i class="icon icon--github" aria-hidden="true"></i>
                                    <span class="screen-reader">Compte github de Maxime Colin</span>
                                </a>
                                                                                        <a href="https://www.maximecolin.fr/"
                                    target="_blank"
                                    rel="noreferrer"
                                    class="social social--small"
                                >
                                    <i class="icon icon--website" aria-hidden="true"></i>
                                    <span class="screen-reader">Site personnel de Maxime Colin</span>
                                </a>
                                                    </div>
                    </div>
                                    </div>

                <div class="bricks">
            
                            <div class="brick-contribute">
                    <p>
                        Une typo ?
                        <a href="https://github.com/Elao/elao_/edit/fix/carrire-social-links/content/blog/infra/provisonner-simplement-stack-monitoring-telegraf-influxdb-grafana-avec-manala.md/" target="_blank" class="animated-link animated-link--light">
                            Modifier cet article sur Github
                        </a>
                    </p>
                </div>
                    </div>
            </div>
        </main>
                    
<footer class="footer">
    <div class="container">
        <section class="footer__links">
            <p class="h1">
                elao
                <span>développe</span>
                <span>du lien</span>
            </p>
            <div class="links">
                                    <ul>
                                                    <li>
                                <a href="/elao_/pr/661/nos-services/" >Services</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/661/demarche" >Démarche</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/661/etudes-de-cas" >Études de cas</a>
                            </li>
                                            </ul>
                                    <ul>
                                                    <li>
                                <a href="/elao_/pr/661/nos-valeurs" >Valeurs</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/661/equipe" >L&#039;équipe</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/661/blog" >Blog</a>
                            </li>
                                                    <li>
                                <a href="/elao_/pr/661/blog/rss.xml"  data-no-swup="data-no-swup">RSS</a>
                            </li>
                                            </ul>
                                <ul>
                    <li>
                        <a href="/elao_/pr/661/carriere">Page Carrière</a>
                    </li>
                    <li>
                        <a href="/elao_/pr/661/glossaire/">Glossaire 🧐</a>
                    </li>
                    <li>
                        <a href="/elao_/pr/661/elaomojis">Elaomojis 🎉</a>
                    </li>
                </ul>
            </div>
            <div class="socials">
                <ul>
                    <li>
                        <a href="https://www.linkedin.com/company/elao/" target="_blank">
                            <i class="icon icon--linkedin"></i>
                            Linkedin
                        </a>
                    </li>
                    <li>
                        <a href="https://bsky.app/profile/elao.com" target="_blank">
                            <i class="icon icon--bluesky"></i>
                            Bluesky
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/elao" target="_blank">
                            <i class="icon icon--x"></i>
                            X
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/elao" target="_blank">
                            <i class="icon icon--github"></i>
                            Github
                        </a>
                    </li>
                </ul>
            </div>
            <div class="contacts">
                <ul>
                    <li>
                        <a href="/elao_/pr/661/contact">Contact</a>
                    </li>
                    <li>
                        <a href="tel:04 82 53 37 19">04 82 53 37 19</a>
                    </li>
                    <li>
                        <a href="mailto:contact@elao.com">contact@elao.com</a>
                    </li>
                    <li>34 rue Jean Broquin</li>
                    <li>69006 Lyon</li>
                </ul>
            </div>
        </section>

        <section class="footer__legals">
            <span>© 2005 - 2025 - ELAO - Tous droits réservés</span>
            <a href="/elao_/pr/661/legal">Mentions légales</a>
            <a href="/elao_/pr/661/confidentialite">Protection des données</a>
            <a id="see" href="#ssss">🐍</a>
        </section>
    </div>
</footer>

            </body>
</html>
